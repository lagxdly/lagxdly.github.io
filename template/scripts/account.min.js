const ANIMATION_SPEED=100;$(function(){if(window.loaderTimout){setTimeout(function(){$(".loader_new").fadeOut(150)},window.loaderTimout)}else{$(".loader_new").fadeOut(150)}});$(function(){let filters=$(".filters");if(filters.length){let selects=filters.find("select"),inputs=filters.find("input:not([readonly])");selects.on("change",function(){let uri=URI(filters.data("link")?filters.data("link"):location.href);selects.each(function(){let element=$(this);uri.removeSearch(element.attr("name"));if(element.val())uri.addSearch(element.attr("name"),element.val())});if(inputs.length)inputs.each(function(){let element=$(this);uri.removeSearch(element.attr("name"));if(element.val())uri.addSearch(element.attr("name"),element.val())});location.assign(uri.toString())})}});$(function(){let multiple=$(".multiple");if(multiple.length){let template=multiple.children(":last").remove();multiple.find(".mdi-plus-box").on("click",function(e){e.preventDefault();let element=template.clone();multiple.append(element);init(element)});init(multiple);function init(element){element.find(".mdi-window-close").on("click",function(e){e.preventDefault();$(this).parent().remove()})}}});$(function(){let groups=$("#groups");if(groups.filter('[data-page="edit"]').length){let numbers={};groups.find("[data-group]").each(function(){let element=$(this);numbers[element.data("group")]=element});groups.find("button").on("click",function(){let element=$(this),from=element.prev().val(),to=from==1?2:1;element.prev().val(to);numbers[to].append(element.closest("li"))})}});$(function(){let years=$("#years");if(years.length){let from=years.find("[data-from]"),to=years.find("[data-to]");init();from.on("change",init);function init(){if(from.val())to.val(parseInt(from.val())+1)}}});$(function(){let preview=$("[data-preview]");if(preview.length){let modal,cropper,reader=new FileReader,xhr=new XMLHttpRequest;preview.each(function(){let element=$(this);if(element.is("[data-edit]"))element.after('<label class="delete"><input type="checkbox" name="'+element.children().attr("name")+'_" class="uk-checkbox"> '+global.translations.delete_photo+"</label>");if(!element.data("preview")){let children=element.children();element.after('<input name="'+children.attr("name")+'" class="uk-hidden">');children.removeAttr("name")}});preview.on("change",function(){let element=$(this),input=element.children("input");reader.onload=function(){if(element.data("cropper")){if(!modal){modal=$('<section data-uk-modal><div class="uk-modal-dialog"><div class="uk-modal-header"><h3 class="uk-modal-title">'+global.translations.prepare_image+'</h3><button class="uk-modal-close-default" data-uk-close></button></div><div class="uk-modal-body"><div><img></div></div><div class="uk-modal-footer uk-flex uk-flex-between"><button class="send uk-button uk-button-primary">'+global.translations.done+'</button><span><button class="uk-button uk-button-default mdi mdi-rotate-left"></button><button class="uk-button uk-button-default mdi mdi-rotate-right"></button></span><button class="close uk-button uk-button-default">'+global.translations.cancel+"</button></div></div></section>");modal.image=modal.find("img");modal.image.attr("src",reader.result);modal.find(".send").on("click",function(){if(element.data("preview")){let data=new FormData;data.append("image",cropper.getCroppedCanvas().toDataURL());data.append(global.csrf.name,global.csrf.hash);xhr.open("POST",element.data("preview"));xhr.send(data)}else{element.next().val(cropper.getCroppedCanvas().toDataURL())}element.css("background-image","url("+cropper.getCroppedCanvas().toDataURL()+")");UIkit.modal(modal).hide()});modal.find(".close").on("click",function(){UIkit.modal(modal).hide()});modal.find(".mdi-rotate-left").on("click",function(){cropper.rotate(-90)});modal.find(".mdi-rotate-right").on("click",function(){cropper.rotate(90)})}if(!cropper){setTimeout(function(){cropper=new Cropper(modal.image[0],{viewMode:2,aspectRatio:parseFloat(element.data("cropper")),autoCropArea:1})},100)}else{cropper.replace(reader.result)}UIkit.modal(modal,{stack:true}).show()}else{element.css("background-image","url("+reader.result+")")}};reader.readAsDataURL(input[0].files[0])})}});$(function(){let date=$("[data-date]"),dateAlternate=$("[data-date-alternate]"),time=$("[data-time]"),datetime=$("[data-datetime]"),calendar=$("[data-calendar]"),calendar_=$("#calendar"),period=$("[data-period]");if(date.length){window.date=[];date.each(function(){let element=$(this),dateVar=element.data("date-var"),calendar;calendar=element.flatpickr({disableMobile:true,locale:"ru",enable:dateVar&&window[dateVar]?window[dateVar]:window.dates?dates:[],dateFormat:element.data("format")?element.data("format"):"Y-m-d",minDate:element.data("min-date")?element.data("min-date"):null,maxDate:element.data("max-date")?element.data("max-date"):null,onChange:function(data,value){if(element.filter("[data-show-warning]").length){if(value)element.removeClass("uk-form-warning");else element.addClass("uk-form-warning")}}});window.date.push(calendar);if(element.data("link")){element.on("change",function(){location.assign(URI(element.data("link")).removeSearch("date").addSearch("date",element.val()).toString())})}})}if(dateAlternate.length){dateAlternate.each(function(){new Cleave(this,{date:true,delimiter:"."})})}if(time.length){time.flatpickr({dateFormat:"H:i",disableMobile:true,enableTime:true,noCalendar:true,time_24hr:true,locale:"ru"})}if(datetime.length){datetime.flatpickr({dateFormat:"Y-m-d H:i",disableMobile:true,enableTime:true,time_24hr:true,locale:"ru"})}if(calendar.length){const instance=flatpickr(calendar.find(calendar.data("calendar")),{defaultDate:calendar.data("current"),disableMobile:true,locale:"ru",onChange:function(selectedDates){location.assign(URI(location.href).removeSearch(calendar.data("name")).addSearch(calendar.data("name"),selectedDates[0].getFullYear()+"-"+(selectedDates[0].getMonth()+1)+"-"+selectedDates[0].getDate()))}});calendar.find("select").on("change",function(){let element=$(this);if(element.val()=="calendar")instance.open()})}if(period.length){let previous,calendar,selects={};period.parent().next().children("[hidden]").each(function(){let element=$(this);element.wrap("<div hidden></div>");selects[element.attr("name")]=element.select2({width:"100%",containerCssClass:"without",dropdownCssClass:"without",minimumResultsForSearch:-1})});period.on("focus",function(){previous=this.value}).on("change",function(){let uri=URI(location.href);uri.removeSearch(["period","quarter","month","week","from","to","date"]);switch(period.val()){case"today":case"yesterday":uri.addSearch("period",period.val());location.assign(uri.toString());break;case"day":calendar=$("<div></div>");calendar.insertAfter(period);calendar.init=flatpickr(calendar,{locale:"ru",onChange:function(dates){uri.addSearch({period:"day",date:moment(dates[0]).format("YYYY-MM-DD")});location.assign(uri.toString())},onClose:function(){period.children('[value="'+previous+'"]').prop("selected","selected");calendar.remove()}});setTimeout(function(){calendar.init.open()},250);break;case"period":calendar=$("<div></div>");calendar.insertAfter(period);calendar.init=flatpickr(calendar,{mode:"range",locale:"ru",onChange:function(dates){if(dates.length==2){uri.addSearch({period:"period",from:moment(dates[0]).format("YYYY-MM-DD"),to:moment(dates[1]).format("YYYY-MM-DD")});location.assign(uri.toString())}},onClose:function(){period.children('[value="'+previous+'"]').prop("selected","selected");calendar.remove()}});setTimeout(function(){calendar.init.open()},250);break;case"week":selects["week"].parent().removeAttr("hidden");selects["week"].select2("open");selects["week"].on("select2:select",function(){uri.addSearch({period:"week",week:this.value});location.assign(uri.toString())}).on("select2:close",function(){period.children('[value="'+previous+'"]').prop("selected","selected");selects["week"].select2("close");selects["week"].parent().prop("hidden","hidden")});break;case"month":selects["month"].parent().removeAttr("hidden");selects["month"].select2("open");selects["month"].on("select2:select",function(){uri.addSearch({period:"month",month:this.value});location.assign(uri.toString())}).on("select2:close",function(){period.children('[value="'+previous+'"]').prop("selected","selected");selects["month"].select2("close");selects["month"].parent().prop("hidden","hidden")});break;case"quarter:1":case"quarter:2":case"quarter:3":case"quarter:4":uri.addSearch({period:"quarter",quarter:period.val().split(":")[1]});location.assign(uri.toString());break;case"year":uri.addSearch({period:"year"});location.assign(uri.toString());break;default:return null}})}});$(function(){let work=$("#work"),submit=$("#response");if(work.length){let theme=work.find('select[name="theme"]');theme.on("change",function(){let data={action:"get",theme_id:theme.val()};data[global.csrf.name]=global.csrf.hash;$.post(theme.data("link"),data,function(response){if(response){response=$.parseJSON(response);CKEDITOR.instances.text.setData(response.work)}})})}if(submit.length){UIkit.util.on(submit,"shown",function(){if(!submit.editor){CKEDITOR.plugins.add("number",{init:function(editor){editor.addCommand("insertNumber",{exec:function(editor){editor.insertHtml("№")}});editor.ui.addButton("Number",{label:"Вставить №",icon:"/template/images/editor/number.png",command:"insertNumber",toolbar:"paragraph"})}});CKEDITOR.plugins.add("paragraph",{init:function(editor){editor.addCommand("insertParagraph",{exec:function(editor){editor.insertHtml("§")}});editor.ui.addButton("Paragraph",{label:"Вставить §",icon:"/template/images/editor/paragraph.png",command:"insertParagraph",toolbar:"paragraph"})}});CKEDITOR.plugins.add("kyrgyz_o",{init:function(editor){editor.addCommand("insertKyrgyzO",{exec:function(editor){editor.insertHtml("ө")}});editor.ui.addButton("KyrgyzO",{label:"Вставить Ө",icon:"/template/images/editor/kyrgyz_o.png",command:"insertKyrgyzO",toolbar:"paragraph"})}});CKEDITOR.plugins.add("kyrgyz_y",{init:function(editor){editor.addCommand("insertKyrgyzY",{exec:function(editor){editor.insertHtml("ү")}});editor.ui.addButton("KyrgyzY",{label:"Вставить Ү",icon:"/template/images/editor/kyrgyz_y.png",command:"insertKyrgyzY",toolbar:"paragraph"})}});CKEDITOR.plugins.add("kyrgyz_n",{init:function(editor){editor.addCommand("insertKyrgyzN",{exec:function(editor){editor.insertHtml("ң")}});editor.ui.addButton("KyrgyzN",{label:"Вставить Ң",icon:"/template/images/editor/kyrgyz_n.png",command:"insertKyrgyzN",toolbar:"paragraph"})}});submit.editor=CKEDITOR.replace(submit.find("textarea")[0],{uiColor:"#F9F9F9",removeButtons:"Cut,Copy,Paste,Undo,Redo,Strike,Subscript,Superscript,Outdent,Indent,Link,Unlink,Anchor,About",extraPlugins:"number,paragraph,kyrgyz_o,kyrgyz_y,kyrgyz_n"})}})}});$(function(){let chained=$("select[data-chained]"),selects=$("select[data-select]"),selected=$("select[data-selected]");if(chained.length){chained.each(function(){let element=$(this);element.chained(element.data("chained"))})}if(selects.length){if(!window.selects)window.selects={};selects.each(function(){let element=$(this);window.selects[element.attr("name")]=element.select2({width:"100%",placeholder:global.translations.not,tags:element.data("tags")?true:false});if(element.data("select")=="all"){let link=$('<a href="#" class="link uk-float-right mdi mdi-checkbox-multiple-marked" title="'+global.translations.select_all+'"></a>');element.after(link);link.on("click",function(e){e.preventDefault();let options=[];element.children().each(function(){options.push($(this).attr("value"))});window.selects[element.attr("name")].val(options).trigger("change")})}})}if(selected.length){selected.on("change",function(){let element=$(this);if(element.val())element.addClass(selected.data("selected"));else element.removeClass(selected.data("selected"))})}});$(function(){let sortable=$("[data-sortable]");if(sortable.length){let data=sortable.data("sortable");Sortable.create(sortable[0],{handle:".handle",onSort:function(){let items=[];switch(data.type){case"input":sortable.find('input[name="item[]"]').each(function(){items.push($(this).val())});break}if(items){$.post(data.url,{items:items})}}})}});$(function(){let editor=$("textarea[data-editor]");editorInit(editor)});window.editor=[];function editorInit(editor){editor.each(function(){let element=$(this),params={uiColor:"#F9F9F9",extraPlugins:"autolink,number,paragraph,kyrgyz_o,kyrgyz_y,kyrgyz_n",toolbar:[["Undo","Redo"],["Bold","Italic","Underline","TextColor"],["NumberedList","BulletedList","Subscript","Superscript"],["JustifyLeft","JustifyCenter","JustifyRight"],["Link","Image","Table"],["SpecialChar","Number","Paragraph","KyrgyzO","KyrgyzY","KyrgyzN"]],removeDialogTabs:"link:target;link:advanced;image:advanced",removePlugins:"elementspath,contextmenu,liststyle,tabletools,tableselection",specialChars:["&radic;","!","&quot;","#","$","%","&amp;","'","(",")","*","+","-",".","/","0","1","2","3","4","5","6","7","8","9",":",";","&lt;","=","&gt;","?","@","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","[","]","^","_","`","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","{","|","}","~","&euro;","&lsquo;","&rsquo;","&ldquo;","&rdquo;","&ndash;","&mdash;","&iexcl;","&cent;","&pound;","&curren;","&yen;","&brvbar;","&sect;","&uml;","&copy;","&ordf;","&laquo;","&not;","&reg;","&macr;","&deg;","&sup2;","&sup3;","&acute;","&micro;","&para;","&middot;","&cedil;","&sup1;","&ordm;","&raquo;","&frac14;","&frac12;","&frac34;","&iquest;","&Agrave;","&Aacute;","&Acirc;","&Atilde;","&Auml;","&Aring;","&AElig;","&Ccedil;","&Egrave;","&Eacute;","&Ecirc;","&Euml;","&Igrave;","&Iacute;","&Icirc;","&Iuml;","&ETH;","&Ntilde;","&Ograve;","&Oacute;","&Ocirc;","&Otilde;","&Ouml;","&times;","&Oslash;","&Ugrave;","&Uacute;","&Ucirc;","&Uuml;","&Yacute;","&THORN;","&szlig;","&agrave;","&aacute;","&acirc;","&atilde;","&auml;","&aring;","&aelig;","&ccedil;","&egrave;","&eacute;","&ecirc;","&euml;","&igrave;","&iacute;","&icirc;","&iuml;","&eth;","&ntilde;","&ograve;","&oacute;","&ocirc;","&otilde;","&ouml;","&divide;","&oslash;","&ugrave;","&uacute;","&ucirc;","&uuml;","&yacute;","&thorn;","&yuml;","&OElig;","&oelig;","&#372;","&#374","&#373","&#375;","&sbquo;","&#8219;","&bdquo;","&hellip;","&trade;","&#9658;","&bull;","&rarr;","&rArr;","&hArr;","&diams;","&asymp;"],resize_enabled:false};if(window.editorConfigs){if(window.editorConfigs.imagePath){params.filebrowserUploadMethod="form";params.filebrowserImageUploadUrl=window.editorConfigs.imagePath}}window.editor[element.attr("name")]=CKEDITOR.replace(element[0],params);if(element.data("toolbar-collapse")){let parent=element.closest(".elementEditor");parent.find("[data-show-toolbar]").on("click",function(e){e.preventDefault();parent.toggleClass("elementEditor")})}})}$(function(){let help=$("[data-help]");if(help.length){help.each(function(){let element=$(this),tooltip=$('<span class="help uk-hidden">'+element.data("help")+"</span>");element.wrap('<span class="uk-inline uk-width-1-1"></span>');element.after(tooltip)});help.on("focusin",function(){$(this).next().removeClass("uk-hidden")});help.on("focusout",function(){$(this).next().addClass("uk-hidden")})}});$(function(){let journal=$("#journal");if(journal.filter('[data-page="view"]').length){let theme=journal.find('select[name="theme"]'),date=journal.find('.calendar_ input[name="date"]'),importTheme=journal.find("a[data-import]"),thead=journal.find("table[data-thead]"),theadClone,themes=journal.find("table[data-themes]"),getThemes=journal.find("a[data-get-themes]"),themesBlock=journal.find("div.themesBlock");theme.each(function(){let theme=$(this);theme.on("change",function(){if(theme.val()<0){location.assign(theme.data("add"))}else if(theme.val()==0){$.post(theme.data("remove"),function(){location.reload()})}else{$.post(theme.data("edit")+"/"+theme.val(),function(){location.reload()})}})});if(date.length){date.flatpickr({defaultDate:date.val(),enable:dates,disableMobile:true,locale:"ru"});date.on("change",function(){location.assign(URI(date.data("link")).addSearch("date",date.val()))})}journal.find("[data-view-theme]").on("click",function(e){e.preventDefault();let element=$(this);$.post(local.links.themes,{action:"getJournalTheme",theme:element.data("view-theme")},function(response){UIkit.modal(response).show()})});$("body").on("touchend",".full_name",function(e){let element=$(this);if(element.filter('[aria-expanded="true"]').length)e.preventDefault()});importTheme.on("click",function(e){e.preventDefault();$.post(importTheme.data("import"),function(response){let copyFrom=$(response),yearThemes=copyFrom.find("[data-year]");copyFrom.footer=copyFrom.find(".uk-modal-footer");copyFrom.sectionPlans=copyFrom.find('[data-section="plans"]');copyFrom.sectionThemes=copyFrom.find('[data-section="themes"]');copyFrom.find("select[data-select-year]").on("change",function(){let element=$(this);yearThemes.prop("hidden",true);yearThemes.filter('[data-year="'+element.val()+'"]').prop("hidden",false)});copyFrom.find("[data-plan]").on("click",function(){let element=$(this);copyFrom.plan=element.data("plan");$.post(copyFrom.sectionThemes.data("link"),{action:"get_themes",withoutCheckbox:true,dataAttribute:"theme",onlyLearned:element.data("current-plan")?1:0,plan:copyFrom.plan},function(response){copyFrom.sectionThemes.children("ul").html(response);copyFrom.sectionThemes.find("[data-view]").on("click",function(e){e.preventDefault();let element=$(this);$.post(copyFrom.sectionThemes.data("link"),{action:"get",theme:element.data("view"),withoutButtons:true},function(response){UIkit.modal(response).show()})});copyFrom.sectionPlans.prop("hidden",true);copyFrom.sectionThemes.prop("hidden",false);copyFrom.footer.prop("hidden",false)})});copyFrom.find('a[data-action="return"]').on("click",function(e){e.preventDefault();copyFrom.sectionPlans.prop("hidden",false);copyFrom.sectionThemes.prop("hidden",true);copyFrom.footer.prop("hidden",true)});copyFrom.on("click","[data-theme]",function(e){e.preventDefault();let element=$(this);if(confirm(local.translations.confirm_import)){$.post(copyFrom.data("link"),{action:"importAttach",lesson:importTheme.data("lesson"),theme:element.data("theme")},function(){location.reload()})}});UIkit.modal(copyFrom).show()})});getThemes.on("click",function(e){e.preventDefault();themesBlock.toggle(ANIMATION_SPEED,function(){getThemes.data("get-themes",parseInt(getThemes.data("get-themes"))?"0":"1");getThemes.children().prop("hidden",true);getThemes.children('[data-view="'+getThemes.data("get-themes")+'"]').prop("hidden",false);window.dispatchEvent(new Event("resize"))})})}if(journal.filter(".journal_add").length){let marks=journal.find(".marks"),actions=marks.find("a[data-action]"),smileAction=actions.filter('[data-action="smile"]'),smileIcon="star2",smiles=marks.find("a[data-smile]"),note=marks.find("input"),table=journal.find("table"),comment=journal.find(".comment"),sendButton=journal.find("#sendButton"),notes=journal.find(".notes"),audioContext,audio=comment.find(".audio"),timer=comment.find(".timer"),encoder,microphone,processor,tracks,mp3Data,mp3buf;window.URL=window.URL||window.webkitURL;window.AudioContext=window.AudioContext||window.webkitAudioContext;navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;notes.find("[data-note]").on("click",function(e){e.preventDefault();let element=$(this);notes.prev().val(element.text());notes.prop("hidden",true)});notes.find("[data-delete-note]").on("click",function(e){e.preventDefault();let element=$(this);$.get(element.data("delete-note"),function(){element.closest("li").remove()})});note.on("click",function(){notes.prop("hidden",true)});actions.on("click",function(e){e.preventDefault();let element=$(this);if(element.data("action")!="smile"){if(!element.hasClass("active")){actions.removeClass("active");element.addClass("active");if(element.data("action")=="info"&&element.data("note"))note.val(element.data("note"));else note.val("");note.parent().slideUp(200);notes.prop("hidden",false);window.mark={action:element.data("action"),text:element.text()}}else{if(!element.filter('[data-action="clear"]').length){note.parent().slideDown(200)}}if(element.data("action")=="info"&&!element.data("note")){note.parent().slideDown(200)}}});smiles.on("click",function(e){e.preventDefault();let element=$(this);actions.removeClass("active");smileAction.addClass("active");UIkit.drop(element.closest(".uk-drop")).hide(0);smileAction.children().removeClass("smile-"+smileIcon).addClass("smile-"+element.data("smile"));smileIcon=element.data("smile");note.val("");note.parent().slideDown(200);window.mark={action:"smile",smile:smileIcon}});table.on("click",".mark span",function(){let element=$(this),mark_=element.parent().children('[data-type="mark"]'),note_=element.parent().children('[data-type="note"]');if(window.mark){element.html("");element.removeClass("mark");element.parent().children("input").val("");if(note.val()){note_.val(note.val());element.addClass("mark")}switch(window.mark.action){case"mark":mark_.val(window.mark.text);element.text(window.mark.text);break;case"not":mark_.val("-1");element.html("<small>"+window.mark.text+"</small>");break;case"info":element.html('<i class="mdi mdi-information-variant"></i>');break;case"smile":note_.val("[smile]"+window.mark.smile+"|~|"+note.val());element.html('<i class="smile smile-'+window.mark.smile+' smile-inner"></i>');break;case"absent":mark_.val("-1");element.text(window.mark.text);break;case"clear":mark_.removeAttr("value");element.text("");break}if(window.mark.action!="clear")element.addClass("active");else element.removeClass("active");if(initSend)initSend()}});$("#add_column").on("click",function(e){e.preventDefault();table.find("tr").each(function(){let element=$(this),last=element.children(":last"),clone=last.clone(),span=clone.children('span[data-type="mark"]');span.html("");span.removeClass("mark");clone.children("input").val("");last.after(clone)});table.closest(".uk-overflow-auto").scrollLeft(1e4)});if(comment.length){comment.find(".mdi-microphone").on("click",function(){let element=$(this);if(element.hasClass("active")){stop_record()}else{mp3Data=[];audioContext=new AudioContext;processor=audioContext.createJavaScriptNode?audioContext.createJavaScriptNode(2048,1,1):audioContext.createScriptProcessor(2048,1,1);processor.connect(audioContext.destination);navigator.mediaDevices.getUserMedia({audio:true,video:false}).then(function(stream){tracks=stream.getTracks();microphone=audioContext.createMediaStreamSource(stream);microphone.connect(processor);encoder=new lamejs.Mp3Encoder(1,48e3,64);processor.onaudioprocess=function(event){let data=event.inputBuffer.getChannelData(0),dataAsInt16Array=new Int16Array(data.length);for(let i=0;i<data.length;i++)dataAsInt16Array[i]=Math.max(-32768,Math.min(32768,data[i]<0?data[i]*32768:data[i]*32767));if(dataAsInt16Array.length>0)mp3Data.push(encoder.encodeBuffer(dataAsInt16Array))};element.addClass("active");sendButton.prop("hidden",true);timer.counter=1;timer.text("00:00 / 10:00");timer.timer=setInterval(function(){let minutes=Math.floor(timer.counter/60),seconds=Math.floor(timer.counter%60);if(minutes<10)minutes="0"+minutes;if(seconds<10)seconds="0"+seconds;timer.text(minutes+":"+seconds+" / 10:00");timer.counter++},1e3)}).catch(function(){UIkit.notification({message:global.translations.not_audio,status:"warning",pos:"top-right"})})}});function stop_record(){let reader=new FileReader,blob;audioContext.close();processor.disconnect();tracks.forEach(track=>track.stop());mp3buf=encoder.flush();if(mp3buf.length>0)mp3Data.push(new Int8Array(mp3buf));blob=new Blob(mp3Data,{type:"audio/mpeg"});comment.find(".mdi-microphone").removeClass("active").parent().fadeOut(100);audio.fadeIn(100);sendButton.prop("hidden",false);window["audio"]["comment"].setSrc(URL.createObjectURL(blob));reader.readAsDataURL(blob);reader.onloadend=function(){comment.find('[name="audio"]').val(reader.result)};clearTimeout(timer.timer);timer.text("")}comment.find(".mdi-close-circle").on("click",function(){comment.find('[name="audio"]').val("");comment.find('[name="audio_"]').val("1");comment.find(".mdi-microphone").parent().fadeIn(100);audio.fadeOut(100)})}if(journal.filter(".withConfirm").length){let submit=journal.find('[data-action="submit"]'),confirm=journal.find('[data-action="confirm"]');confirm.on("change",function(){initSend(true)});function initSend(isCheckbox){let marks=journal.find('[data-type="mark"][value]').length;if(!isCheckbox&&marks)confirm.prop("checked",true)}window.checkForm=function(){if(!confirm.prop("checked")){UIkit.notification({message:global.translations.wholeClassWas_alert,status:"danger",pos:"top-center",timeout:5e3});return false}else{return true}}}window["checkSelectedDate"]=function(){return!!$(window.date[0].input).val()}}if(journal.filter(".journal_sick").length){let marks=journal.find(".marks"),actions=marks.find("a"),note=marks.find("input"),table=journal.find("table");actions.on("click",function(e){e.preventDefault();let element=$(this);if(!element.hasClass("active")){actions.removeClass("active");element.addClass("active");if(element.data("disable-comment")){note.val(element.data("disable-comment")).attr("readonly",true);note.parent().slideDown(200)}else if(element.filter("[data-open-comment]").length){note.val("").attr("readonly",false);note.parent().slideDown(200)}else{note.val("").attr("readonly",false);note.parent().slideUp(200)}window.sick={action:element.data("action"),text:element.data("label")?element.data("label"):element.text(),letter:element.data("letter"),description:element.children(".info.move").length?element.children(".info.move").text():"",reason:element.data("reason")?element.data("reason"):"0"}}else{if(!element.filter('[data-action="clear"]').length)note.parent().slideDown(200)}});table.on("click",".mark span",function(){let element=$(this),sick_=element.prev("input"),note_=sick_.prev("input"),reason_=note_.prev("input");if(window.sick){element.html("");element.removeClass("mark");sick_.val("");note_.val("");reason_.val(window.sick.reason);element.find(".info").remove();if(note.val()&&!window.sick.description){note_.val(note.val());element.addClass("mark")}switch(window.sick.action){case"absent":sick_.val(3);element.text(window.sick.text);break;case"sick":sick_.val(1);element.text(window.sick.text);break;case"good":sick_.val(2);element.text(window.sick.letter);break;case"clear":sick_.val("");element.text("");break}if(window.sick.description)element.append('<span class="info">'+window.sick.description+"</span>");if(window.sick.action!="clear")element.addClass("active");else element.removeClass("active")}})}if(journal.filter(".journal_student").length){let marks=journal.find(".marks"),actions=marks.find("a"),note=marks.find("input"),mark=journal.find(".average .mark");actions.on("click",function(e){e.preventDefault();let element=$(this);if(!element.hasClass("active")){actions.removeClass("active");element.addClass("active");note.val("");note.parent().slideUp(200);window.mark={action:element.data("action"),text:element.text()}}else{if(!element.filter('[data-action="clear"]').length)note.parent().slideDown(200)}if(element.data("action")=="info"){note.parent().slideDown(200)}});mark.on("click",function(){let element=$(this),mark_=element.parent().children('[data-type="mark"]'),note_=element.parent().children('[data-type="note"]');if(window.mark){element.html("");element.removeClass("mark_");element.parent().children("input").val("");if(note.val()){note_.val(note.val());element.addClass("mark_")}switch(window.mark.action){case"mark":mark_.val(window.mark.text);element.text(window.mark.text);break;case"not":mark_.val("-1");element.html("<small>"+window.mark.text+"</small>");break;case"info":element.html('<i class="mdi mdi-information-variant"></i>');break;case"clear":mark_.val("");element.text("");break}if(window.mark.action!="clear")element.addClass("active");else element.removeClass("active")}})}});$(function(){let shave_two=$(".shave_two");if(shave_two.length){shave_two.shave(50)}});$(function(){let reports=$("#reports");if(reports.length){let charts=reports.find(".chart canvas"),colors=["#8389E0","#C785C8","#60C5F1"];charts.each(function(){let chart=$(this);if(chart_[chart.data("name")].type=="single"){new Chart(chart[0],{type:"line",data:{labels:chart_[chart.data("name")].data.labels,datasets:[{label:chart_[chart.data("name")].title,borderColor:colors[0],fill:false,data:chart_[chart.data("name")].data.data}]}})}else{let data=[];for(let i in chart_[chart.data("name")].data.data){let current=chart_[chart.data("name")].data.data[i];data.push({label:current.label,borderColor:colors[i],fill:false,data:current.data})}new Chart(chart[0],{type:"line",data:{labels:chart_[chart.data("name")].data.labels,datasets:data},options:{tooltips:{mode:"index",intersect:false}}})}})}});$(function(){let analytics=$("#analytics");if(analytics.length){let marks=analytics.find("#marks");if(marks.length){new Chart(marks[0],{type:"bar",data:{labels:chart.marks.labels,datasets:[{data:chart.marks.data,backgroundColor:chart.marks.colors}]},options:{title:{display:true,text:marks.data("title")},legend:{display:false},aspectRatio:4}})}analytics.find("canvas[data-name]").each(function(){let element=$(this),name=element.data("name");new Chart(element[0],{type:"pie",data:{labels:chart[name].labels,datasets:[{data:chart[name].data,backgroundColor:chart[name].colors}]},options:{title:{display:true,text:element.data("title")},aspectRatio:2.5}})})}});$(function(){let plans=$("#plans");if(plans.filter('[data-page="themes"]').length){let table=plans.find("table"),tbody=table.find("tbody[data-not-learned]"),views=table.find("a[data-view]"),copyFrom=$("#copy_from");plans.find('[data-action="deletePlans"]').on("click",function(e){e.preventDefault();UIkit.modal.labels.ok=global.translations.yes;UIkit.modal.labels.cancel=global.translations.cancel;UIkit.modal.confirm(global.translations.delete_confirm).then(function(){let items=[];plans.find('[name="item[]"]:checked').each(function(){items.push($(this).val())});if(plans.length){$.post(plans.data("link"),{action:"massDelete",items:items},function(){location.reload()})}})});if(tbody.length){Sortable.create(tbody[0],{handle:".mdi-menu",draggable:"[data-id]",onEnd:function(){let ids=[];tbody.children("[data-id]").each(function(){let element=$(this);ids.push(element.data("id"))});$.post(plans.data("link"),{action:"sort",themes:ids},function(){location.reload()})}})}views.on("click",function(e){e.preventDefault();let element=$(this);$.post(plans.data("link"),{action:"get",return:element.data("return"),theme:element.data("view")},function(response){UIkit.modal(response).show()})});table.find('select[name="theme"]').on("change",function(){let element=$(this);if(element.val()<0){location.assign(element.data("add"))}else if(element.val()==0){$.post(element.data("remove"),function(){location.reload()})}else{$.post(element.data("edit")+"/"+element.val(),function(){location.reload()})}});$("#copy_to").on("submit",function(e){e.preventDefault();let element=$(this),targets=element.find('input[name="target[]"]:checked'),targets_=[],items=table.find('input[name="item[]"]:checked'),items_=[];if(!targets.length)return false;targets.each(function(){targets_.push($(this).val())});items.each(function(){items_.push($(this).val())});$.post(element.data("link"),{action:"copy_to",items:items_,targets:targets_},function(){location.reload()})});let yearThemes=copyFrom.find("[data-year]");copyFrom.footer=copyFrom.find(".uk-modal-footer");copyFrom.sectionPlans=copyFrom.find('[data-section="plans"]');copyFrom.sectionThemes=copyFrom.find('[data-section="themes"]');copyFrom.find("select[data-select-year]").on("change",function(){let element=$(this);yearThemes.prop("hidden",true);yearThemes.filter('[data-year="'+element.val()+'"]').prop("hidden",false)});copyFrom.find("[data-plan]").on("click",function(){let element=$(this);copyFrom.plan=element.data("plan");$.post(copyFrom.sectionThemes.data("link"),{action:"get_themes",plan:copyFrom.plan},function(response){copyFrom.sectionThemes.children("ul").html(response);checkboxesInit(copyFrom.sectionThemes);copyFrom.sectionThemes.find("[data-view]").on("click",function(e){e.preventDefault();let element=$(this);$.post(copyFrom.sectionThemes.data("link"),{action:"get",theme:element.data("view"),withoutButtons:true},function(response){UIkit.modal(response).show()})});copyFrom.sectionPlans.prop("hidden",true);copyFrom.sectionThemes.prop("hidden",false);copyFrom.footer.prop("hidden",false)})});copyFrom.find('a[data-action="return"]').on("click",function(e){e.preventDefault();copyFrom.sectionPlans.prop("hidden",false);copyFrom.sectionThemes.prop("hidden",true);copyFrom.footer.prop("hidden",true)});copyFrom.on("submit",function(e){e.preventDefault();let element=$(this),targets=element.find('input[name="target[]"]:checked'),targets_=[];if(copyFrom.sectionThemes.prop("hidden"))return false;if(!targets.length)return false;targets.each(function(){targets_.push($(this).val())});$.post(element.data("link"),{action:"copy_from",plan:element.data("plan"),targets:targets_},function(){location.reload()})})}});$(function(){let messages=$("#messages");if(messages.filter('[data-page="lesson"]').length){let link=messages.data("link"),list=messages.find(".list"),send=messages.find(".send"),last=messages.data("last"),delete_after=messages.data("after"),html=$("html");if(send.length){let input=send.find('input[name="message"]'),textMessage=send.find(".controls:first"),audioMessage=textMessage.next(),recordAudio=textMessage.find('[data-toggle="record"]'),removeAudio=audioMessage.find('[data-toggle="remove"]'),recordTimer=send.find(".timer"),sendButton=send.find("button.mdi-send"),recordTimer_,recordedAudio="",audioContext,timer,counter,sending=false,encoder,microphone,processor,tracks,mp3Data,mp3buf;window.URL=window.URL||window.webkitURL;window.AudioContext=window.AudioContext||window.webkitAudioContext;navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;send.on("submit",function(e){e.preventDefault();if(sending)return null;sending=true;let message=$.trim(input.val());input.val("");if(message||recordedAudio){recordAudio.hide();removeAudio.hide();sendButton.removeClass("mdi-send").addClass("mdi-spin mdi-loading");$.post(link+"/add",{message:message,audio:recordedAudio},function(){audioMessage.fadeOut(100,function(){textMessage.fadeIn(100)});recordedAudio=null;load_messages(true);window["audio"]["message"].pause();recordAudio.show();removeAudio.show();sendButton.removeClass("mdi-spin mdi-loading").addClass("mdi-send");sending=false})}else{sending=false}});list.on("click",'[data-action="delete"]',function(e){e.preventDefault();let element=$(this);$.post(link+"/delete",{message_id:element.data("id")},function(){element.closest(".inner").fadeOut(250,function(){$(this).remove()})})});function load_messages(scroll){$.post(link+"/get",{last_id:last,delete_after:delete_after},function(response){if(!response)return null;let messages=$(response.messages);if(response.messages){list.append(messages);if(scroll||html.scrollTop()>list.offset().top){html.animate({scrollTop:html.height()},500)}$("[data-audio]").mediaelementplayer({audioWidth:"100%",startVolume:1,enableKeyboard:false,features:["playpause","current","progress","duration"]});last=response.last}if(response.deleted){response.deleted.forEach(function(item){list.children('[data-id="'+item+'"]').find(".text").addClass("uk-text-muted").text(global.translations.message_deleted)});delete_after=response.deleted_after}})}setInterval(load_messages,15e3);recordAudio.on("click",function(){if(recordAudio.hasClass("active")){clearTimeout(timer);recordAudio.toggleClass("mdi-microphone mdi-spin mdi-loading");stop_record()}else{send.addClass("sending");sendButton.hide();mp3Data=[];audioContext=new AudioContext;processor=audioContext.createJavaScriptNode?audioContext.createJavaScriptNode(2048,1,1):audioContext.createScriptProcessor(2048,1,1);processor.connect(audioContext.destination);navigator.mediaDevices.getUserMedia({audio:true,video:false}).then(function(stream){tracks=stream.getTracks();microphone=audioContext.createMediaStreamSource(stream);microphone.connect(processor);encoder=new lamejs.Mp3Encoder(1,48e3,64);processor.onaudioprocess=function(event){let data=event.inputBuffer.getChannelData(0),dataAsInt16Array=new Int16Array(data.length);for(let i=0;i<data.length;i++)dataAsInt16Array[i]=Math.max(-32768,Math.min(32768,data[i]<0?data[i]*32768:data[i]*32767));if(dataAsInt16Array.length>0)mp3Data.push(encoder.encodeBuffer(dataAsInt16Array))};recordAudio.addClass("active");counter=1;recordTimer.fadeIn(100);recordTimer.text("00:00 / 10:00");recordTimer_=setInterval(function(){let minutes=Math.floor(counter/60),seconds=Math.floor(counter%60);if(minutes<10)minutes="0"+minutes;if(seconds<10)seconds="0"+seconds;recordTimer.text(minutes+":"+seconds+" / 10:00");counter++},1e3)}).catch(function(error){UIkit.notification({message:global.translations.not_audio,status:"warning",pos:"top-right"})})}});removeAudio.on("click",function(e){e.preventDefault();audioMessage.fadeOut(100,function(){textMessage.fadeIn(100)});recordedAudio=null;window["audio"]["message"].pause();input.prop("required","required")});function stop_record(){let reader=new FileReader,blob;audioContext.close();processor.disconnect();tracks.forEach(track=>track.stop());mp3buf=encoder.flush();if(mp3buf.length>0)mp3Data.push(new Int8Array(mp3buf));blob=new Blob(mp3Data,{type:"audio/mpeg"});recordAudio.removeClass("active");window["audio"]["message"].setSrc(URL.createObjectURL(blob));reader.readAsDataURL(blob);reader.onloadend=function(){recordedAudio=reader.result};send.removeClass("sending");textMessage.fadeOut(100,function(){audioMessage.fadeIn(100);recordAudio.removeClass("mdi-spin mdi-loading").addClass("mdi-microphone");sendButton.show()});input.removeAttr("required");clearInterval(recordTimer_);recordTimer.fadeOut(100)}}}if(messages.filter('[data-page="message"]').length){let send=messages.find(".send"),message=send.find("input"),latest=messages.find("#latest");send.on("submit",function(e){e.preventDefault();$.post(location.href,{action:"send",message:message.val()},function(response){latest.before(response);$(document).scrollTop(latest.offset().top);message.val("")})});setInterval(function(){$.post(location.href,{action:"loading"},function(response){response=$.parseJSON(response);if(response.messages){latest.before(response.messages);$(document).scrollTop(latest.offset().top)}if(response.deleted){response.deleted.forEach(function(value){messages.find('[data-inner-id="'+value+'"]').remove()})}})},1e4);messages.on("click","[data-delete-message]",function(e){e.preventDefault();let element=$(this);$.post(element.data("delete-message"),function(){element.closest("[data-inner-id]").fadeOut(ANIMATION_SPEED)})})}});if(window.mejs){mejs.i18n.language("ru");$("[data-audio]").mediaelementplayer({audioWidth:"100%",startVolume:1,enableKeyboard:false,features:["playpause","current","progress","duration"],success:function(media,node){let name=$(node).data("name");if(!window["audio"])window["audio"]={};if(name)window["audio"][name]=media}})}$(function(){let import_=$("#import");if(import_.length){import_.find('select[name="class[]"]').on("change",function(){let element=$(this),parent=element.closest("div"),next=parent.next().add(parent.next().next());if(element.val()==-1)next.removeAttr("hidden");else next.prop("hidden","hidden")})}});$(function(){let color=$("input[data-color]");if(color.length){let picker=new CP(color[0]),current=color.val();picker.on("change",function(value){color.val(value.toUpperCase());color.css({borderColor:"#"+value,background:"#"+value})})}});$(function(){let toggles=$("[data-toggle]");if(toggles.length){toggles.on("change",function(){let element=$(this);location.assign(element.data("toggle")+"/"+element.val())})}});$(function(){let body=$("body");body.on("click","[data-delete]",function(e){e.preventDefault();let element=$(this);UIkit.modal.labels.ok=global.translations.yes;UIkit.modal.labels.cancel=global.translations.cancel;UIkit.modal.confirm(global.translations.delete_confirm).then(function(){if(element.data("double")){UIkit.modal.confirm(global.translations.delete_confirm_double).then(function(){location.assign(element.data("delete"))})}else{if(!element.filter("[data-is-ajax]").length){location.assign(element.data("delete"))}else{if(!element.data("post")){$.get(element.data("delete"),function(){location.reload()})}else{$.post(element.data("delete"),element.data("post"),function(){location.reload()})}}}})});body.on("click","[data-multiple-delete]",function(e){e.preventDefault();let element=$(this),messages=element.data("multiple-delete").split("|");for(let i=1;i<messages.length;i++)if(!confirm(messages[i]))return null;location.assign(messages[0])})});$(function(){let confirm=$("[data-confirm]");if(confirm.length){confirm.on("click",function(e){e.preventDefault();let element=$(this);UIkit.modal.labels.ok=global.translations.yes;UIkit.modal.labels.cancel=global.translations.cancel;UIkit.modal.confirm(element.data("confirm")).then(function(){location.assign(element.data("link"))})})}});$(function(){let query=$("[data-query]");if(query.length){query.on("change",function(){let element=$(this),link=element.children(":selected").data("link");if(link){location.assign(link)}else{let uri=URI(element.data("link")?element.data("link"):location.href);if(element.val()!="calendar"){uri.removeSearch(element.data("query"));if(element.val())uri.addSearch(element.data("query"),element.val());location.assign(uri)}}})}});$(function(){let menu=$("[data-select-menu]");if(menu.length){menu.on("change",function(){location.assign($(this).val())})}});$(function(){$("body").on("click","[data-href]",function(e){let element=$(this),target=$(e.target);if(!target.hasClass("no_click")&&!target.closest(".no_click").length){e.preventDefault();if(element.filter('[target="_blank"]').length||element.filter("[data-blank]").length||e.ctrlKey)window.open(element.data("href"));else location.assign(element.data("href"))}})});$(function(){let lessons=$("#lessons");if(lessons.filter('[data-page="view"]').length){let theme=lessons.find(".theme select"),startBroadcast=lessons.find('[data-action="broadcast"]'),broadcast=$("#broadcast_"),broadcastVideo=$("#broadcast_video"),api=null,attachButton=$("[data-attach]"),attachModal=$(".attachModal"),attachComment,attachAudio=attachModal.filter('[data-type="audio"]'),audioSend=attachModal.filter('[data-type="audio"]').find('button[data-action="send"]'),uploader=$('<div class="uploader" style="display: none;"><i class="mdi mdi-loading mdi-spin"></i><span>'+global.translations.uploaded+"</span><span data-percent></span></div>"),percent=uploader.find("[data-percent]"),responses=$("#responses"),timer=attachAudio.find(".timer span"),recorder={},value,recordAudio=attachAudio.find(".record a"),player=attachAudio.find(".player audio"),audioContext,status=false,gumStream,input,files,for_,encoder,microphone,processor,tracks,wavData,mp3Data,mp3buf,stream;window.URL=window.URL||window.webkitURL;window.AudioContext=window.AudioContext||window.webkitAudioContext;navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;if(attachButton.length)uploader.appendTo("body");theme.on("change",function(){if(theme.val()<0){location.assign(theme.data("add"))}else if(theme.val()==0){$.post(theme.data("remove"),function(){location.reload()})}else{$.post(theme.data("edit")+"/"+theme.val(),function(){location.reload()})}});$("body").on("click",'[data-action="presence"]',function(){let element=$(this);$.post(element.data("link"),function(){element.removeClass("uk-button-default").addClass("uk-button-success").html('<i class="mdi mdi-check-bold uk-margin-xsmall-right"></i>'+element.text());element.removeAttr("data-action")})});startBroadcast.on("click",function(){let element=$(this);if(element.data("type")!="jitsi"){broadcast.find(".uk-modal-title").text(element.data("content-title"));broadcast.find('[data-action="content"]').text(element.data("content-content"));broadcast.find('[name="type"]').val(element.data("type"));broadcast.find('[name="link"]').val(element.data("link"));UIkit.modal(broadcast).show()}else{$.post(broadcast.attr("action"),{type:"jitsi"},function(){location.reload()})}});lessons.find('[data-action="jitsi"]').on("click",function(){let element=$(this);broadcastVideo.slideToggle(150,function(){if(broadcastVideo.filter(":not(:hidden)").length){api=new JitsiMeetExternalAPI("meet.jit.si",{roomName:element.data("room"),parentNode:broadcastVideo.find(".inner")[0],configOverwrite:{defaultLanguage:"ru",localRecording:{enabled:true}},interfaceConfigOverwrite:{HIDE_INVITE_MORE_HEADER:true,MOBILE_APP_PROMO:false,TOOLBAR_BUTTONS:["microphone","camera","desktop","raisehand","videoquality","fullscreen","recording"],DEFAULT_LOGO_URL:"images/watermark.png"},userInfo:{displayName:element.data("name"),avatarUrl:element.data("photo")}})}else{api.dispose()}})});attachButton.add(attachModal.find(".add")).on("click",function(e){e.preventDefault();let element=$(this),input,modal,modalOpen;if(element.data("container"))responses=$(element.data("container"));if(element.data("for"))for_=element.data("for");switch(element.data("attach")){case"camera":modal=attachModal.filter('[data-type="photo"]');input=modal.find("input");input.click();if(!input.hasClass("init")){files=[];input.on("change",function(e){let images=input.parent().children(".images"),reader=new FileReader;modalOpen=modal.hasClass("uk-open");if(!modalOpen){images.children(":not(.add)").remove();files=[]}modal.find(".spinner").prop("hidden",false);modal.find(".uk-modal-footer").prop("hidden",true);UIkit.modal(modal).show();new Compressor(e.target.files[0],{maxWidth:1920,maxHeight:1920,quality:.6,mimeType:"image/jpeg",success:function(result){reader.onload=function(){images.children(".add").before('<div><div class="image"><div style="background-image: url('+reader.result+');"></div></div></div>');files.push(result);modal.find(".spinner").prop("hidden",true);modal.find(".uk-modal-footer").prop("hidden",false)};reader.readAsDataURL(result)}});input.addClass("init")})}break;case"audio":UIkit.modal(attachModal.filter('[data-type="audio"]')).show();break;case"video":UIkit.modal(attachModal.filter('[data-type="video"]')).show();break;case"image":modal=attachModal.filter('[data-type="image"]');input=modal.find('input[type="file"]');input.click();if(!input.hasClass("init")){files=[];input.on("change",function(e){let images=input.parent().children(".images");modalOpen=modal.hasClass("uk-open");if(!modalOpen){images.children(":not(.add)").remove();files=[]}modal.find(".spinner").prop("hidden",false);modal.find(".uk-modal-footer").prop("hidden",true);UIkit.modal(modal).show();for(let i=0;i<e.target.files.length;i++){let reader=new FileReader;if(e.target.files[i].name.match(/\.heic$/)){heic2any({blob:e.target.files[i],toType:"image/jpeg"}).then(result=>{result.name=e.target.files[i].name;new Compressor(result,{maxWidth:1920,maxHeight:1920,quality:.6,mimeType:"image/jpeg",success:function(result){reader.onload=function(){images.children(".add").before('<div><div class="image"><div style="background-image: url('+reader.result+');"></div></div></div>');files.push(result);if(i+1==e.target.files.length){modal.find(".spinner").prop("hidden",true);modal.find(".uk-modal-footer").prop("hidden",false)}};reader.readAsDataURL(result)}})})}else{new Compressor(e.target.files[i],{maxWidth:1920,maxHeight:1920,quality:.6,mimeType:"image/jpeg",success:function(result){reader.onload=function(){images.children(".add").before('<div><div class="image"><div style="background-image: url('+reader.result+');"></div></div></div>');files.push(result);if(i+1==e.target.files.length){modal.find(".spinner").prop("hidden",true);modal.find(".uk-modal-footer").prop("hidden",false)}};reader.readAsDataURL(result)}});reader.readAsDataURL(e.target.files[i])}}input.addClass("init")})}break;case"document":input=attachModal.filter('[data-type="document"]').find("input");input.click();input.on("change",function(e){input.next().children(".name").text(e.target.files[0].name);UIkit.modal(attachModal.filter('[data-type="document"]')).show()});input.on("click",function(e){$(this).val("")});break;case"link":UIkit.modal(attachModal.filter('[data-type="link"]')).show();break;case"comment":if(!attachComment)attachComment=ckeditor_init(attachModal.filter('[data-type="comment"]').find("textarea")[0]);UIkit.modal(attachModal.filter('[data-type="comment"]')).show();break}});attachModal.find('button[data-action="send"]').on("click",function(){let element=$(this),section=element.closest("[data-type]"),formData=new FormData,result=true;if(section.hasClass("sending"))return null;recorder.sendEnd=[];if(for_)formData.append("for",for_);switch(section.data("type")){case"photo":case"image":if(files.length){for(let i=0;i<files.length;i++)formData.append("file_"+i,files[i],files[i].name);formData.append("action","add");formData.append("type","image");formData.append("lessonID",lessons.data("lesson-id"));files=[]}else{result=false}break;case"audio":if(!status&&attachAudio.recordData){formData.append("action","add");formData.append("type","audio");formData.append("audio",attachAudio.recordData);formData.append("duration",timer.counter);formData.append("lessonID",lessons.data("lesson-id"))}else if(status){recordAudio.removeClass("mdi-microphone").addClass("mdi-spin mdi-loading");audioSend.css("visibility","hidden");stopRecord();formData.append("action","add");formData.append("type","audio");formData.append("duration",timer.counter);formData.append("lessonID",lessons.data("lesson-id"));recorder.sendEnd=[section,formData];result=false}else{alert(global.translations.record_before_send);result=false}break;case"document":if(section.find("input")[0].files.length){formData.append("action","add");formData.append("type","document");formData.append("document",section.find("input")[0].files[0]);formData.append("lessonID",lessons.data("lesson-id"))}else{result=false}break;case"video":case"link":value=$.trim(section.find("input").val());if(value){formData.append("action","add");formData.append("type","link");formData.append("link",value);formData.append("lessonID",lessons.data("lesson-id"))}else{alert(global.translations.fill_field);result=false}break;case"comment":value=$.trim(attachComment.getData());if(value){formData.append("action","add");formData.append("type","comment");formData.append("comment",value);formData.append("lessonID",lessons.data("lesson-id"))}else{alert(global.translations.fill_field);result=false}break}if(result){sendResponse(section,formData)}});function sendResponse(section,formData){section.addClass("sending");$.ajax({url:lessons.data("responses-url"),type:"POST",cache:false,contentType:false,processData:false,data:formData,beforeSend:function(){percent.text("0%");uploader.fadeIn(100)},success:function(response){if(isJSON(response)){response=$.parseJSON(response);if(!response.error){responses.append(response.data);attachAudio.recordData="";attachAudio.find(".player").prop("hidden",true);attachModal.filter('[data-type="link"]').find("input").val("");if(attachComment)attachComment.setData("");if(window.notificationMessage){UIkit.notification({message:window.notificationMessage,status:"success"})}}else{UIkit.notification({message:response.error,status:"warning"})}}else{responses.append(response);attachAudio.recordData="";attachAudio.find(".player").prop("hidden",true);attachModal.filter('[data-type="link"]').find("input").val("");if(attachComment)attachComment.setData("");UIkit.notification({message:window.notificationMessage,status:"success"})}section.removeClass("sending");UIkit.modal(section).hide();uploader.fadeOut(100)},xhr:function(){let xhr=new window.XMLHttpRequest;xhr.upload.addEventListener("progress",function(e){if(e.lengthComputable){let result=parseInt(e.loaded/e.total*100);percent.text(result+"%")}},false);xhr.upload.addEventListener("load",function(e){percent.text(global.translations.upload_finish)});return xhr}})}recordAudio.on("click",function(e){e.preventDefault();if(!status){navigator.mediaDevices.getUserMedia({audio:true,video:false}).then(function(stream){gumStream=stream;audioContext=new AudioContext;input=audioContext.createMediaStreamSource(stream);recorder=new WebAudioRecorder(input,{workerDir:"/template/libraries/encoder/",encoding:"mp3",numChannels:2,onComplete:function(recorder,blob){let reader=new FileReader;window["audio"]["response"].setSrc(URL.createObjectURL(blob));reader.readAsDataURL(blob);reader.onloadend=function(){attachAudio.recordData=reader.result;if(recorder.sendEnd){recorder.sendEnd[1].append("audio",attachAudio.recordData);sendResponse(recorder.sendEnd[0],recorder.sendEnd[1])}};player.closest(".player").prop("hidden",false);recordAudio.addClass("mdi-microphone").removeClass("mdi-spin mdi-loading");audioSend.css("visibility","visible")},onTimeout:function(recorder){stopRecord()}});recorder.setOptions({timeLimit:600,encodeAfterRecord:true,mp3:{bitRate:64}});recorder.startRecording();recordAudio.addClass("active");timer.parent().prop("hidden",false);timer.counter=1;timer.text("00:00");timer.interval=setInterval(function(){let minutes=Math.floor(timer.counter/60),seconds=Math.floor(timer.counter%60);if(minutes<10)minutes="0"+minutes;if(seconds<10)seconds="0"+seconds;timer.text(minutes+":"+seconds);timer.counter++},1e3);player.closest(".player").prop("hidden",true);status=true}).catch(function(error){UIkit.notification({message:"Запись аудио не доступна. Возможные причины: доступ к микрофону запрещен или версия приложения устарела (необходимо обновить приложение Күндөлүк).",status:"warning",pos:"top-right"})})}else{recordAudio.removeClass("mdi-microphone").addClass("mdi-spin mdi-loading");audioSend.css("visibility","hidden");stopRecord()}});function stopRecord(){recordAudio.removeClass("active");clearInterval(timer.interval);timer.parent().prop("hidden",true);status=false;gumStream.getAudioTracks()[0].stop();recorder.finishRecording()}UIkit.util.on(attachAudio,"hidden",function(){if(status)stopRecord()});lessons.on("click","[data-delete-response]",function(e){e.preventDefault();let element=$(this);if(confirm(global.translations.delete_confirm)){$.post(lessons.data("responses-url"),{action:"delete",responseID:element.data("delete-response")},function(){element.parent().remove()})}})}if(lessons.filter('[data-page="replace"]').length){let params=lessons.find("[data-param]");lessons.find('select[name^="teacher"]').on("change",function(){let element=$(this),row=element.closest("tr");if(element.val()){row.find('select[name^="type"], input[name^="comment"]').prop("disabled",false);row.find('select[name^="type"]').val(params.filter('[data-param="type"]').val());row.find('input[name^="comment"]').val(params.filter('[data-param="comment"]').val())}else{row.find('select[name^="type"]').prop("disabled",true).val(params.filter('[data-param="type"]').children(":first").attr("value"));row.find('input[name^="comment"]').prop("disabled",true).val("")}})}if(lessons.filter('[data-page="add"]').length){let lesson=lessons,subjects=lesson.find('select[name^="subject"]'),teachers=lesson.find('select[name^="teacher"]'),groups=lesson.find('select[name^="group"]'),rooms=lesson.find('select[name^="room"]'),split=lesson.find('input[name="split"]'),combined=lesson.find('input[name="combined"]');if(split.prop("checked")){$("#split").removeAttr("hidden");groups.removeAttr("disabled");if(split.prop("checked")){subjects.children('[data-groups!="0"][value!=""]').each(function(){let element=$(this);element.text("* "+element.text())})}}subjects.on("change",function(){let element=$(this),another=subjects.filter(":eq("+(subjects.index(element)?0:1)+")"),next=element.next(),change=element.next().next();if(element.val()==another.val()&&groups.filter(":first").val()==groups.filter(":last").val()){groups.filter(":last").val(groups.filter(":first").val()=="1"?"2":"1")}if(split.prop("checked")&&!element.children(":selected").data("groups"))next.removeAttr("hidden");else next.prop("hidden","hidden");if(split.prop("checked")&&element.children(":selected").data("groups")){change.removeAttr("hidden");change.children().attr("href",change.children().data("link")+"/"+element.children(":selected").data("groups")+"?return=1")}else{change.prop("hidden","hidden")}});teachers.on("change",function(){let element=$(this),another=teachers.filter(":eq("+(teachers.index(element)?0:1)+")");if(!combined.prop("checked")&&element.val()==another.val()){another.val("")}});groups.on("change",function(){let element=$(this),another=groups.filter(":eq("+(groups.index(element)?0:1)+")");if(subjects.filter(":first").val()==subjects.filter(":last").val()&&element.val()==another.val()){another.val(element.val()=="1"?"2":"1")}});rooms.on("change",function(){let element=$(this),another=rooms.filter(":eq("+(rooms.index(element)?0:1)+")");if(!combined.prop("checked")&&element.val()==another.val()){another.val("")}});split.on("change",function(){if(split.prop("checked")){subjects.children('[data-groups!="0"][value!=""]').each(function(){let element=$(this);element.text("* "+element.text())});groups.removeAttr("disabled");groups.closest("div").removeAttr("hidden");if(!subjects.filter(":last").val()){subjects.filter(":last").children('[value="'+subjects.filter(":first").val()+'"]').prop("selected","selected");groups.filter(":last").children('[value="'+(groups.filter(":first").val()==1?2:1)+'"]').prop("selected","selected")}}else{subjects.children('[data-groups!="0"][value!=""]').each(function(){let element=$(this);element.text(element.text().substr(2))});groups.prop("disabled","disabled");groups.closest("div").prop("hidden","hidden")}});combined.on("change",function(){let element=$(this);if(split.prop("checked")&&!element.prop("checked")){teachers.change();rooms.change()}});lessons.find('select[name^="teacher"]').on("change",function(){let element=$(this),option=element.children(":selected"),busy=element.next("small");if(option.data("class"))busy.removeAttr("hidden").text(global.translations.teacher_busy.replace("{class}",option.data("class")).replace("{subject}",option.data("subject")));else busy.attr("hidden","hidden")})}});$(function(){let import_=$("#import");if(import_.filter('[data-page="check"]').length){import_.find("tr[data-edit]").on("click",function(){let element=$(this);$.post(location.href,{action:"get_inner",inner_id:element.data("edit")},function(response){response=$(response);let parents=response.find('[name$="[check]"]'),dates=response.find('[name="birth"], [name$="[birth]"]'),letters=response.find('[name="letter"]');UIkit.modal(response).show();if(dates.length){dates.flatpickr({disableMobile:true,locale:"ru"})}if(letters.length){letters.select2({tags:true})}if(parents.length){parents.on("change",function(){let element=$(this),block=element.closest("div").next("div");if(element.prop("checked")){block.removeAttr("hidden");block.find("input").prop("required","required")}else{block.prop("hidden","hidden");block.find("input").removeAttr("required")}})}response.find("[data-remove]").on("click",function(){let element=$(this);$.post(location.href,{action:"delete_inner",inner_id:element.data("remove")},function(){import_.find("#inner_"+element.data("remove")).remove();UIkit.modal(response).hide();if(!import_.find('tr[id^="inner"]').length)location.reload()})})})})}});$(function(){let schools=$("#schools");if(schools.filter('[data-page="list"]').length){schools.find(".mdi[data-id]").on("click",function(e){e.preventDefault();let element=$(this);$.post(location.href,{action:"get_school",school_id:element.data("id")},function(response){response=$(response);UIkit.modal(response).show();response.find('[name="date"]').flatpickr({disableMobile:true,locale:"ru"});CKEDITOR.replace(response.find('[name="comment"]')[0],{removeButtons:"Cut,Copy,Paste,Undo,Redo,Strike,Subscript,Superscript,Outdent,Indent,Link,Unlink,Anchor,About"})})})}});$(function(){let students=$("#students");if(students.filter('[data-page="view"]').length){students.find("[data-transfer]").on("click",function(){let element=$(this);$.post(location.href,{action:"get_transfer",transfer_id:element.data("transfer")},function(response){response=$(response);let date=response.find("[data-date]");if(date.length){date.flatpickr({disableMobile:true,locale:"ru"})}UIkit.modal(response).show()})})}if(students.filter('[data-page="edit"]').length){let free=students.find('input[name="freeLicense"]'),reason=students.find('input[name="freeLicenseReason"]'),date=students.find('input[name="date"]');free.on("click",function(){if(free.prop("checked"))reason.prop("required",true).closest("div").prop("hidden",false);else reason.prop("required",false).closest("div").prop("hidden",true)});students.find('select[name="reason"]').on("click",function(){let element=$(this);if(element.val()==88)date.val(element.data("start-year")).prop("disabled",true);else date.val("").prop("disabled",false)})}});$(function(){let bells=$("#bells");if(bells.filter('[data-page="bells_edit"]').length){let days={},inputs=bells.find("[data-time-mask]");bells.find("table[data-day]").each(function(){let element=$(this);days[element.data("day")]=element});bells.find("button[data-copy]").on("click",function(){let element=$(this),days_=element.data("copy").split(":"),shifts_=element.data("shifts"),lessons_=element.data("lessons"),zero_=element.data("zero");for(let i=zero_?0:1;i<=lessons_;i++){days[days_[1]].find('input[name="bell['+days_[1]+"]["+i+'][0]"]').val(days[days_[0]].find('input[name="bell['+days_[0]+"]["+i+'][0]"]').val());days[days_[1]].find('input[name="bell['+days_[1]+"]["+i+'][1]"]').val(days[days_[0]].find('input[name="bell['+days_[0]+"]["+i+'][1]"]').val())}});inputs.each(function(){let element=$(this);new Cleave(element[0],{time:true,timePattern:["h","m"]})});inputs.on("focus",function(){let element=$(this);if(!element.val()){if(element.data("position")=="first"){element.val(element.closest("tr").prev().find('[data-position="second"]').val()).select()}else{element.val(element.closest("td").find('[data-position="first"]').val()).select()}}})}if(bells.filter('[data-page="shifts_edit"]').length){bells.find("[data-uk-tab] a").on("click",function(){$(this).next().prop("checked","checked")});bells.find('[data-content="select"]').on("change",function(){let element=$(this),quantity=element.val(),shifts=element.closest("fieldset").children('[data-content="shifts"]').children();for(let i=0;i<3;i++){if(i<quantity)shifts.filter(":eq("+i+")").fadeIn(100);else shifts.filter(":eq("+i+")").fadeOut(100)}})}});$(function(){let ajax=$("[data-ajax]");if(ajax.length){let modal,cropper,reader=new FileReader,xhr=new XMLHttpRequest;ajax.filter("[data-crop]").on("change",function(){let element=$(this),input=element.children("input");reader.onload=function(){if(!modal){modal=$('<section data-uk-modal><div class="uk-modal-dialog"><div class="uk-modal-header"><h3 class="uk-modal-title">'+global.translations.prepare_image+'</h3><button class="uk-modal-close-default" data-uk-close></button></div><div class="uk-modal-body"><div><img></div></div><div class="uk-modal-footer uk-flex uk-flex-between"><button class="send uk-button uk-button-primary">'+global.translations.done+'</button><span><button class="uk-button uk-button-default mdi mdi-rotate-left"></button><button class="uk-button uk-button-default mdi mdi-rotate-right"></button></span><button class="close uk-button uk-button-default">'+global.translations.cancel+"</button></div></div></section>");modal.image=modal.find("img");modal.image.attr("src",reader.result);modal.find(".send").on("click",function(){let data=new FormData;data.append("image",cropper.getCroppedCanvas().toDataURL());xhr.onload=function(){if(element.data("reload"))location.reload()};xhr.open("POST",element.data("ajax"));xhr.send(data)});modal.find(".close").on("click",function(){UIkit.modal(modal).hide()});modal.find(".mdi-rotate-left").on("click",function(){cropper.rotate(-90)});modal.find(".mdi-rotate-right").on("click",function(){cropper.rotate(90)})}if(!cropper){setTimeout(function(){cropper=new Cropper(modal.image[0],{viewMode:2,aspectRatio:parseFloat(element.data("crop")),autoCropArea:1})},100)}else{cropper.replace(reader.result)}UIkit.modal(modal,{stack:true}).show()};reader.readAsDataURL(input[0].files[0])});ajax.filter(":not([data-crop])").on("click",function(){let element=$(this);$.post(element.data("ajax"),function(){if(element.data("reload"))location.reload()})})}});$(function(){let classes=$("#classes");if(classes.length){if(classes.data("page")=="edit"){classes.find('[name="letter"]').select2({tags:true})}if(classes.data("page")=="list"){classes.find("[data-get-students]").on("click",function(){let element=$(this);if(element.hasClass("active"))return false;element.addClass("active");$.post(element.data("get-students"),function(response){response=$(response);element.after(response);UIkit.dropdown(response,{mode:"click"}).show()})})}}});$(function(){let multiple=$(".file_multiple"),files=$(".file_select");if(multiple.length){multiple.find(".add i").on("click",function(){let element=$(this),parent=element.closest(".file_multiple"),files=parent.children(".files").children(),last=files.filter(":last"),current=last.clone();if(files.length<parent.data("length")){current.find(".name").text(current.find(".name").data("placeholder"));current.find('input[type="file"]').attr("name",parent.data("name")+"_"+(files.length+1)).val("");current.find(".delete").prop("hidden","hidden");current.find(".delete").next().val("");files_init(current);last.after(current);if(files.length+1>=parent.data("length"))element.parent().prop("hidden","hidden")}})}if(files.length)files_init(files);function files_init(files){files.each(function(){let element=$(this),input=element.find("input"),name=element.find(".name"),delete_=element.find(".delete");input.on("change",function(){if(input.val()){let type=this.files[0].type,size=this.files[0].size/1024/1024;if(input.attr("accept").split(",").indexOf(type)===-1){UIkit.notification({message:global.translations.file_error_type,status:"warning",pos:"top-right"})}else if(size>10){UIkit.notification({message:global.translations.file_error_size,status:"warning",pos:"top-right"})}else{name.text(input.val().split("\\").pop());delete_.removeAttr("hidden")}}else{if(name.data("name")){name.text(name.data("name"));delete_.removeAttr("hidden")}else{name.text(name.data("placeholder"));delete_.prop("hidden","hidden")}}delete_.next().val("")});delete_.on("click",function(){input.val(null);name.text(name.data("placeholder"));delete_.prop("hidden","hidden");if(name.data("name"))delete_.next().val("1")})})}});$(function(){let iframes=$("[data-iframe]");if(iframes.length){iframes.each(function(){let element=$(this),parent=element.data("target")?$(element.data("target")):element.next(),iframe=parent.children();element.on("click",function(e){e.preventDefault();parent.slideToggle(150,function(){if(!iframe.attr("src"))iframe.attr("src",element.data("iframe"))})})})}});$(function(){let exception=$("#exception");if(exception.length){let reason=exception.find('select[name="reason"]'),hides=exception.find(".hides");reason.on("change",function(){if(reason.val()==90)hides.fadeOut(100);else hides.fadeIn(100)})}});$(function(){let forms=$("form[data-ajax-form]");if(forms.length){$("body").on("submit","form[data-ajax-form]",function(e){e.preventDefault();let element=$(this),uploader=$('<div class="uploader" style="display: none;"><i class="mdi mdi-loading mdi-spin"></i><span>'+global.translations.uploaded+"</span><span data-percent></span></div>"),percent=uploader.find("[data-percent]");if(element.data("disabled"))return false;if(window.checkForm&&!window.checkForm())return false;uploader.appendTo("body");if(element.data("ajax-form")!="multipart"){$.ajax({url:element.attr("action"),type:"POST",data:element.serialize(),beforeSend:function(){percent.text("0%");uploader.fadeIn(100)},success:function(response){if(response)response=$.parseJSON(response);if(response.redirect)location.assign(response.redirect);else location.reload()},xhr:function(){let xhr=new window.XMLHttpRequest;xhr.upload.addEventListener("progress",function(e){if(e.lengthComputable){let result=parseInt(e.loaded/e.total*100);percent.text(result+"%")}},false);xhr.upload.addEventListener("load",function(e){percent.text(global.translations.upload_finish)});return xhr}})}else{if(!element.data("check-send")||window[element.data("check-send")]()){let formData=new FormData(element.get(0));$.ajax({url:location.href,type:"POST",cache:false,contentType:false,processData:false,data:formData,beforeSend:function(){percent.text("0%");uploader.fadeIn(100)},success:function(response){if(response)response=$.parseJSON(response);if(response.redirect)location.assign(response.redirect);else location.reload()},xhr:function(){let xhr=new window.XMLHttpRequest;xhr.upload.addEventListener("progress",function(e){if(e.lengthComputable){let result=parseInt(e.loaded/e.total*100);percent.text(result+"%")}},false);xhr.upload.addEventListener("load",function(e){percent.text(global.translations.upload_finish)});return xhr}})}}})}});$(function(){let readmore=$("[data-readmore]");if(readmore.length){readmore.each(function(){let element=$(this);if(element.height()>75){let more=$('<div><a href="#">'+global.translations.read_more+"...</a></div>");element.addClass("readmore");element.after(more);more.children().on("click",function(e){e.preventDefault();element.removeClass("readmore");more.remove()})}})}});$(function(){let shave=$("[data-shave]"),trunk=$("[data-trunk]");if(shave.length){shave.each(function(){let element=$(this);element.shave(element.data("shave"),{character:"..."})})}if(trunk.length){trunk.trunk8()}});$(function(){let warnings=$("[data-change-warning]"),alert=$("[data-change-alert]");if(warnings.length){warnings.on("change",function(){let element=$(this);if(element.filter('input:not([type="checkbox"])').length){if(element.next(".change_warning").length)element.next().remove();if(element.val()!=element.data("change-warning"))element.after('<small class="change_warning uk-text-danger">'+global.translations.change_warning+"</small>")}else if(element.filter("select").length){if(element.next(".change_warning").length)element.next().remove();if(element.children(":selected").attr("value")!=element.data("change-warning"))element.after('<small class="change_warning uk-text-danger">'+global.translations.change_warning+"</small>")}else if(element.filter('input[type="checkbox"]').length){if(element.next().next(".change_warning").length)element.next().next().remove();if(element.prop("checked")!=element.data("change-warning"))element.next().after('<small class="change_warning uk-text-danger">'+global.translations.change_warning+"</small>")}})}if(alert.length){alert.on("change",function(){let element=$(this);if(element.next().next(".change_warning").length)element.next().next().remove();if(element.prop("checked"))element.next().after('<small class="change_warning uk-text-danger">'+element.data("change-alert")+"</small>")})}});$(function(){let transfer=$("#transfer");if(transfer.length){transfer.find('select[data-type="number"]').on("change",function(){let element=$(this);if(element.val()>0)element.next().children().removeAttr("disabled");else element.next().children().prop("disabled","disabled")})}});$(function(){let broadcast=$("#broadcast");if(broadcast.length){let button=broadcast.find(".button"),video=broadcast.find(".video, .mobile"),inner=broadcast.find(".inner"),translations=button.data("translations").split("|"),viewOnStart=broadcast.find("[data-view-on-start]"),api;switch(broadcast.data("for")){case"teacher":if(video.filter(":not(:hidden)").length){if(!video.hasClass("mobile"))api=broadcast_init(inner,broadcast.data("room"),broadcast.data("name"),broadcast.data("photo"))}button.on("click",function(){button.toggleClass("active");video.slideToggle(150,function(){if(video.filter(":not(:hidden)").length){if(!video.hasClass("mobile"))api=broadcast_init(inner,broadcast.data("room"),broadcast.data("name"),broadcast.data("photo"));button.text(translations[1]);viewOnStart.prop("hidden",false)}else{api=null;inner.children().remove();video.hide();button.text(translations[0]);viewOnStart.prop("hidden",true)}$.post(button.data("link"))})});break;case"student":let status=!broadcast.prop("hidden");button.filter(".buttonPC").on("click",function(){video.slideToggle(150,function(){if(video.filter(":not(:hidden)").length){if(!video.hasClass("mobile"))api=broadcast_init(inner,broadcast.data("room"),broadcast.data("name"),broadcast.data("photo"));button.text(translations[1]);viewOnStart.prop("hidden",false)}else{api=null;inner.children().remove();button.text(translations[0]);viewOnStart.prop("hidden",true)}})});setInterval(function(){$.get(button.data("link"),function(response){if(status!=response.status){if(response.status==1){broadcast.prop("hidden",false);if(response.room)broadcast.data("room",response.room)}else{broadcast.prop("hidden",true);api=null;inner.children().remove();button.text(translations[0])}status=!status}})},1e4);break}function broadcast_init(inner,room,name,photo){return new JitsiMeetExternalAPI("meet.jit.si",{roomName:room,parentNode:inner[0],configOverwrite:{defaultLanguage:"ru",localRecording:{enabled:true}},interfaceConfigOverwrite:{HIDE_INVITE_MORE_HEADER:true,MOBILE_APP_PROMO:false,TOOLBAR_BUTTONS:["microphone","camera","desktop","raisehand","videoquality","fullscreen","recording"],DEFAULT_LOGO_URL:"images/watermark.png"},userInfo:{displayName:name,avatarUrl:photo}})}}});$(function(){let loads=$("#loads");if(loads.length){if(loads.filter('[data-page="time"]').length){let shift=loads.find('select[data-type="shift"]'),table=loads.find("table"),toggle=table.find("th.row, th.column");shift.on("change",function(){let index=shift.val().split(":"),hover=table.find(".hover"),input=$([]),status=$([]);if(shift.val()){index=[parseInt(index[0]),parseInt(index[1]),parseInt(index[2])];hover.each(function(){for(let i=index[1];i<=index[2];i++){let field=$(this).children("[data-lesson="+i+"]");input=input.add(field.find("input"));status=status.add(field.find(".status"))}})}else{input=hover.find("input");status=hover.find(".status")}table.find("input").val("3");table.find(".status").removeClass("mdi-check-circle mdi-help-circle").addClass("mdi-close-circle");input.val(1);status.toggleClass("mdi-close-circle mdi-check-circle")});table.find(".toggle").on("click",function(){let element=$(this),input=element.children("input"),value=input.val(),status=element.children(".status");if(value==1){input.val(2);status.toggleClass("mdi-check-circle mdi-help-circle")}else if(value==2){input.val(3);status.toggleClass("mdi-help-circle mdi-close-circle")}else if(value==3){input.val(1);status.toggleClass("mdi-close-circle mdi-check-circle")}toggle.data("status",1)});table.find("th.row").on("click",function(){let element=$(this),row=element.parent(),input=row.find("input"),status=row.find(".status"),first=input.filter(":eq(1)"),similar=true;input.each(function(){if($(this).val()!=first.val())similar=false});if(!element.data("status"))element.data("status",similar?input.val():1);if(similar){if(element.data("status")==1){input.val(2);status.toggleClass("mdi-check-circle mdi-help-circle");element.data("status",2)}else if(element.data("status")==2){input.val(3);status.toggleClass("mdi-help-circle mdi-close-circle");element.data("status",3)}else if(element.data("status")==3){input.val(1);status.toggleClass("mdi-close-circle mdi-check-circle");element.data("status",1)}}else{input.val(1);status.removeClass("mdi-help-circle mdi-close-circle").addClass("mdi-check-circle");element.data("status",1)}});loads.find(".column").on("click",function(){let element=$(this),index=element.index(),input=$([]),status=$([]),similar=true,first;table.find(".hover").each(function(){let field=$(this).children(":eq("+index+")");input=input.add(field.find("input"));status=status.add(field.find(".status"))});first=input.filter(":eq(1)");input.each(function(){if($(this).val()!=first.val())similar=false});if(!element.data("status"))element.data("status",similar?input.val():1);if(similar){if(element.data("status")==1){input.val(2);status.toggleClass("mdi-check-circle mdi-help-circle");element.data("status",2)}else if(element.data("status")==2){input.val(3);status.toggleClass("mdi-help-circle mdi-close-circle");element.data("status",3)}else if(element.data("status")==3){input.val(1);status.toggleClass("mdi-close-circle mdi-check-circle");element.data("status",1)}}else{input.val(1);status.removeClass("mdi-help-circle mdi-close-circle").addClass("mdi-check-circle");element.data("status",1)}})}if(loads.filter('[data-page="view"]').length){let items=loads.find('input[name="item[]"]'),toClass=$("#modal_class"),toTeacher=$("#modal_teacher"),copyClass=$("#fromClass"),copyTeacher=$("#fromTeacher"),fromProgram=$("#fromProgram");fromProgram.programs=fromProgram.find("[data-content-language]");fromProgram.find("[data-select-language]").on("change",function(){fromProgram.programs.prop("hidden",true);fromProgram.programs.filter('[data-content-language="'+$(this).val()+'"]').prop("hidden",false)});fromProgram.on("click","[data-select-program]",function(){$.post(fromProgram.data("programs-url")+"/getInners",{program:$(this).data("select-program"),class:fromProgram.data("to-class")},function(response){response=$(response);UIkit.modal(response).show();response.on("submit",function(e){e.preventDefault();$.post(response.attr("action"),response.serialize(),function(){location.reload()})})})});copyClass.find("[data-get-copy-classes]").on("change",function(){let element=$(this);$.post(element.data("get-copy-classes"),{action:"getCopyClasses",year:element.val()},function(response){response.classes=$(response.classes);copyClassInit(response.classes);element.closest(".uk-modal-body").find("tbody").html(response.classes)})});$(document.body).on("click","[data-copy-class]",function(e){e.preventDefault();let element=$(this),classID=element.data("copy-class");copyClass.find('[data-class-id="'+classID+'"]').prop("hidden",true);copyClass.toID=classID;UIkit.modal(copyClass).show()});copyClassInit(copyClass.find("[data-class-id]"));function copyClassInit(elements){elements.on("click",function(){let element=$(this);copyClass.fromID=element.data("class-id");$.post(copyClass.data("url"),{action:"copyClass",fromID:copyClass.fromID,toID:copyClass.toID},function(responseOut){responseOut=$(responseOut);UIkit.modal(responseOut).show();checkboxesInit(responseOut);responseOut.children().on("submit",function(e){e.preventDefault();let element=$(this);$.post(copyClass.data("url"),element.serialize(),function(response){location.reload()})})})})}$(document.body).on("click","[data-copy-teacher]",function(e){e.preventDefault();let element=$(this),teacherID=element.data("copy-teacher");copyTeacher.find('[data-teacher-id="'+teacherID+'"]').prop("hidden",true);copyTeacher.toID=teacherID;UIkit.modal(copyTeacher).show()});copyTeacher.find("[data-teacher-id]").on("click",function(){let element=$(this);copyTeacher.fromID=element.data("teacher-id");$.post(copyTeacher.data("url"),{action:"copyTeacher",fromID:copyTeacher.fromID,toID:copyTeacher.toID},function(responseOut){responseOut=$(responseOut);UIkit.modal(responseOut).show();checkboxesInit(responseOut);responseOut.children().on("submit",function(e){e.preventDefault();let element=$(this);$.post(copyTeacher.data("url"),element.serialize(),function(){location.reload()})})})});toClass.add(toTeacher).find('button[data-action="submit"]').on("click",function(){let element=$(this),modal=element.closest("[data-uk-modal]"),loads=[],targets=[];items.filter(":checked").each(function(){loads.push($(this).val())});modal.find('input[name="target[]"]').filter(":checked").each(function(){targets.push($(this).val())});$.post(modal.data("link"),{loads:loads,targets:targets},function(response){UIkit.modal(modal).hide();UIkit.notification({message:response.message,status:"success",pos:"top-right"})})});loads.on("click",'[data-action="delete"]',function(){let element=$(this),checkboxes=loads.find('input[name="item[]"]:checked'),loadIDs=[];checkboxes.each(function(){loadIDs.push($(this).val())});if(confirm(element.data("confirm-message"))){$.post(element.data("link"),{loads:loadIDs},function(){location.reload()})}});loads.find("[data-ajax-select]").on("change",function(){let element=$(this);$.post(location.href,{loadID:element.data("ajax-select"),field:element.attr("name"),value:element.val()},function(){location.reload()})})}if(loads.filter('[data-page="list"]').length){let schedule=$("#modal_schedule");loads.find("[data-schedule]").on("click",function(e){e.preventDefault();let element=$(this);$.post(schedule.attr("action"),{action:"get_class",classID:element.data("schedule")},function(response){schedule.find(".uk-modal-title").html(response.title);schedule.find(".uk-modal-body").html(response.content);schedule.find("[data-sort]").each(function(){Sortable.create(this,{group:"schedule",filter:".tableCaption"})});UIkit.modal(schedule).show()})});schedule.find('[data-action="close"]').on("click",function(e){e.preventDefault();if(confirm(global.translations.close_confirm)){UIkit.modal(schedule).hide()}});loads.find("[data-edit-access]").on("click",function(e){e.preventDefault();let element=$(this),url=element.data("edit-access");$.get(url,function(response){response=$(response);response.find("select").select2({width:"100%",tags:true});response.on("submit",function(e){e.preventDefault();$.post(url,response.serialize(),function(){location.reload()})});UIkit.modal(response).show()})})}if(loads.filter('[data-page="addClass"]').length){let templates=loads.find("[data-template]"),content=loads.find("[data-content]"),type=loads.find('select[name="type"]'),certification=loads.find('select[name="certification"]');select_type();type.on("change",select_type);function select_type(){let template,subjects,teachers,lessons,students,inDay,group;switch(type.val()){case"1":template=templates.filter('[data-template="whole"]').children().clone();break;case"100":template=templates.filter('[data-template="select"]').children().clone();break;default:template=templates.filter('[data-template="groups"]').children().clone();for(let i=1;i<=type.val();i++){let counter=0;group=templates.filter('[data-template="group"]').children().clone();group.find("legend").text(global.translations.groups_number.replace("{num}",i));students=group.find("[data-students]");students.data("group",i-1);if(students.length&&globalGroups[type.val()]&&globalGroups[type.val()][i]){globalGroups[type.val()][i].forEach(function(studentID){let student=templates.filter('[data-template="student"]').children().clone();student.append("<span data-counter>"+ ++counter+"</span>. "+globalStudents[studentID].name);student.children("input").attr("name","student["+(i-1)+"][]").val(studentID);students.append(student)})}template.append(group);if(students.length){Sortable.create(students[0],{group:"students",onEnd:function(e){$(e.item).children("input").attr("name","student["+$(e.to).data("group")+"][]");["from","to"].forEach(function(parent){let counter=0;$(e[parent]).find("[data-counter]").each(function(){$(this).text(++counter)})})}})}}subjects=template.find('[name^="subject"]');subjects.on("change",function(){let element=$(this);subjects.filter(function(){return!this.value}).find('option[value="'+element.val()+'"]').prop("selected",true)});teachers=template.find('[name^="teacher"]:not(:first)');teachers.children(":selected").prop("selected",false);lessons=template.find('[name^="lessons"]');lessons.on("change",function(){let element=$(this);lessons.filter(function(){return!$(this).data("complete")}).data("complete",true).val(element.val())});inDay=template.find('[name^="in_day"]');inDay.on("change",function(){let element=$(this);inDay.filter(function(){return!$(this).data("complete")}).data("complete",true).val(element.val())});break}template.find('[name^="subject"]').on("change",function(){let element=$(this);if(element.val()&&subjectsExists.indexOf(element.val())!=-1)UIkit.modal.alert("Журнал для этого класса по предмету {subject} уже существует!".replace("{subject}",element.children(":checked").text()))});subjectInit(template);content.html(template)}function subjectInit(template){template.find('select[name^="subject"]').on("change",function(){let element=$(this),value=element.children(":selected").data("certification-type");certification.children('[value="'+value+'"]').prop("selected",true)})}}if(loads.filter('[data-page="addTeacher"]').length){let certification=loads.find('select[name="certification"]');loads.find('select[name="subject"]').on("change",function(){let element=$(this),value=element.children(":selected").data("certification-type");certification.children('[value="'+value+'"]').prop("selected",true)});loads.children("form").on("submit",function(){let classes=loads.find('[name="classes[]"]'),subject=loads.find('[name="subject"]'),problem=[];classes.find(":selected").each(function(){let element=$(this);if(subjectsExists.indexOf(element.attr("value")+"_"+subject.find(":selected").data("id"))!=-1)problem.push(element.text())});if(problem.length&&!confirm("Журнал для классов {classes} по предмету {subject} уже существует! Вы по прежнему хотите создать эти журналы?".replace("{subject}",subject.val()).replace("{classes}",problem.join(", "))))return false});loads.find('[name="subject"], [name="classes[]"]').on("change",function(){let element=$(this)})}if(loads.filter('[data-page="editClass"]').length){let students=loads.find('[data-students]:not([data-group="0"])');students.each(function(){Sortable.create(this,{group:"students",onEnd:function(e){$(e.item).children("input").attr("name","student["+$(e.to).data("group")+"][]");["from","to"].forEach(function(parent){let counter=0;$(e[parent]).find("[data-counter]").each(function(){$(this).text(++counter)})})}})})}if(loads.filter('[data-page="addSection"]').length){let students=loads.find("#students");students.find("input[data-select-all]").on("change",function(){let element=$(this);element.closest(element.data("select-all")).find("input").prop("checked",element.prop("checked"))});students.find("input").on("change",function(){let element=$(this),parent=element,checked;while(true){parent=parent.parent().closest("ul");if(!parent.length)break;if(!parent.filter("#students").length){checked=true;parent.find("input").each(function(){if(!$(this).prop("checked"))checked=false});parent.parent().children("input").prop("checked",checked)}else{checked=true;parent.find("input:not([data-select-all])").each(function(){if(!$(this).prop("checked"))checked=false});parent.children(":first").find("input").prop("checked",checked)}}})}if(loads.filter('[data-page="sectionsList"]').length){}}});$(function(){let checkbox=$(".checkboxes"),extended=$(".checkboxesExtended");if(checkbox.length){checkboxesInit(checkbox)}if(extended.length){checkboxesExtendedInit(extended)}});function checkboxesInit(checkbox){let items=checkbox.find(".checkbox"),selectAll=checkbox.find('input[data-action="select_all"]'),viewIsChecked=checkbox.find(".view_is_checked"),hiddenIsChecked=checkbox.find(".hidden_is_checked");console.log(selectAll);selectAll.on("change",function(){items.prop("checked",selectAll.prop("checked"));if(viewIsChecked.length)viewIsChecked.prop("hidden",!items.filter(":checked").length);if(hiddenIsChecked.length)hiddenIsChecked.prop("hidden",items.filter(":checked").length)});items.on("change",function(){selectAll.prop("checked",items.length==items.filter(":checked").length);if(viewIsChecked.length)viewIsChecked.prop("hidden",!items.filter(":checked").length);if(hiddenIsChecked.length)hiddenIsChecked.prop("hidden",items.filter(":checked").length)})}function checkboxesExtendedInit(checkbox){let checkboxes=checkbox.find(".checkbox");checkboxes.filter("input[data-select-all]").on("change",function(){let element=$(this);element.closest(element.data("select-all")).find(".checkbox").prop("checked",element.prop("checked"))});checkboxes.on("change",function(){let element=$(this),parent=element,checked;while(true){parent=parent.parent().closest("ul");if(!parent.length)break;if(!parent.filter(".checkboxesExtended").length){checked=true;parent.find(".checkbox").each(function(){if(!$(this).prop("checked"))checked=false});parent.parent().children(".checkbox").prop("checked",checked)}else{checked=true;parent.find(".checkbox:not([data-select-all])").each(function(){if(!$(this).prop("checked"))checked=false});parent.children(":first").find(".checkbox").prop("checked",checked)}}})}$(function(){let query=$("[data-setquery]");if(query.length){query.filter("select").on("change",function(){let element=$(this),uri=URI(location.href);uri.removeSearch(element.data("setquery"));if(element.val())uri.addSearch(element.data("setquery"),element.val());location.assign(uri)});query.filter("form").on("submit",function(e){e.preventDefault();let element=$(this),input=element.find("input"),uri=URI(location.href);uri.removeSearch(element.data("setquery"));if(input.val())uri.addSearch(element.data("setquery"),input.val());location.assign(uri)})}});$(function(){let main=$("#main");if(main.filter('[data-page="administration"]').length){let map=main.find(".map"),markers=[],group;map=L.map(map[0],{center:[41.21667,75],fullscreenControl:true,zoom:7});map.attributionControl.setPrefix(null);L.tileLayer("https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright/">OpenStreetMap</a>'}).addTo(map);map.scrollWheelZoom.disable();map.on("fullscreenchange",function(){if(map.isFullscreen())map.scrollWheelZoom.enable();else map.scrollWheelZoom.disable()});for(let i=0;i<schools.length;i++){let item=L.marker(schools[i].coords,{title:schools[i].title});item.addTo(map).bindPopup(schools[i].content);markers.push(item)}group=L.featureGroup(markers);map.fitBounds(group.getBounds());setTimeout(function(){map.setZoom(map.getZoom()-1)},500)}});$(function(){let thead=$("table[data-float-thead]");if(thead.length){thead.each(function(){let element=$(this),type=element.data("float-thead");if(!type){element.floatThead()}else if(type=="withNavbar"){element.floatThead({top:$("#navbar").height(),responsiveContainer:function(){return element.parent()}})}else{element.floatThead({scrollContainer:function(table){return table.closest(".uk-overflow-auto")},position:"absolute",floatWrapperClass:"uk-overflow-auto uk-position-absolute uk-position-cover"})}})}});$(function(){let subjects=$("#subjects");if(subjects.filter('[data-page="edit"]').length){subjects.find('input[name="title"], input[name="abbreviation"]').on("keydown",function(){let element=$(this);element.next().prop("hidden",element.val()!=element.data("title"))})}});$(function(){let popupButton=$("[data-popup-button]");if(popupButton.length){popupButton.on("click",function(e){e.preventDefault();window.open($(this).data("popup-button"))})}});$(function(){let forms=$("form[data-form-confirm]");if(forms.length){forms.on("submit",function(){if(!confirm($(this).data("form-confirm")))return false})}});$(document).on("onInit.fb",function(){let toolbar=$(".fancybox-toolbar"),click=1;toolbar.prepend('<button id="rotate_right" class="fancybox-button"><i class="mdi mdi-rotate-right"></i></button>');toolbar.on("click","#rotate_right",function(){toolbar.parent().find(".fancybox-content img").css("transform","rotate("+90*click+++"deg)")})});$(function(){let fancybox=$(".fancybox_wrapper");if(fancybox.length){if(!global.isMobile)fancybox.find('a[href^="https://www.youtube.com"], a[href^="https://youtu.be"]').fancybox()}});$(function(){let autoresize=$("[data-autoresize]");if(autoresize.length){autoresize.each(function(){autosize(this)})}});if(window.CKEDITOR){CKEDITOR.plugins.add("number",{init:function(editor){editor.addCommand("insertNumber",{exec:function(editor){editor.insertHtml("№")}});editor.ui.addButton("Number",{label:"Вставить №",icon:"/template/images/editor/number.png",command:"insertNumber",toolbar:"paragraph"})}});CKEDITOR.plugins.add("paragraph",{init:function(editor){editor.addCommand("insertParagraph",{exec:function(editor){editor.insertHtml("§")}});editor.ui.addButton("Paragraph",{label:"Вставить §",icon:"/template/images/editor/paragraph.png",command:"insertParagraph",toolbar:"paragraph"})}});CKEDITOR.plugins.add("kyrgyz_o",{init:function(editor){editor.addCommand("insertKyrgyzO",{exec:function(editor){editor.insertHtml("ө")}});editor.ui.addButton("KyrgyzO",{label:"Вставить Ө",icon:"/template/images/editor/kyrgyz_o.png",command:"insertKyrgyzO",toolbar:"paragraph"})}});CKEDITOR.plugins.add("kyrgyz_y",{init:function(editor){editor.addCommand("insertKyrgyzY",{exec:function(editor){editor.insertHtml("ү")}});editor.ui.addButton("KyrgyzY",{label:"Вставить Ү",icon:"/template/images/editor/kyrgyz_y.png",command:"insertKyrgyzY",toolbar:"paragraph"})}});CKEDITOR.plugins.add("kyrgyz_n",{init:function(editor){editor.addCommand("insertKyrgyzN",{exec:function(editor){editor.insertHtml("ң")}});editor.ui.addButton("KyrgyzN",{label:"Вставить Ң",icon:"/template/images/editor/kyrgyz_n.png",command:"insertKyrgyzN",toolbar:"paragraph"})}})}function ckeditor_init(element){return CKEDITOR.replace(element,{uiColor:"#F9F9F9",extraPlugins:"autolink,kyrgyz_o,kyrgyz_y,kyrgyz_n",toolbar:[["Undo","Redo"],["Bold","Italic","Underline"],["NumberedList","BulletedList","Subscript","Superscript"],["JustifyLeft","JustifyCenter","JustifyRight"],["Link"],["KyrgyzO","KyrgyzY","KyrgyzN"]],removeDialogTabs:"link:target;link:advanced",removePlugins:"elementspath,contextmenu,liststyle,tabletools,tableselection"})}$(function(){let responses=$(".responsesList");if(responses.length){responses.each(function(){let element=$(this);element.on("click","[data-response-comment]",function(e){e.preventDefault();$.post(element.data("responses-url"),{action:"getComment",responseID:$(this).data("response-comment")},function(response){UIkit.modal(response).show()})});element.on("click","[data-response-audio]",function(e){e.preventDefault();let audio;$.post(element.data("responses-url"),{action:"getAudio",responseID:$(this).data("response-audio")},function(response){response=$(response);response.find("audio").mediaelementplayer({audioWidth:"100%",startVolume:1,enableKeyboard:false,features:["playpause","current","progress","duration"],success:function(media,node){audio=media;audio.load()}});UIkit.modal(response).show();UIkit.util.on(response,"hide",function(){audio.pause()})})})})}});$(function(){let thead=$("table[data-floatTable]");if(thead.length){let navbar=$("#navbar");thead.each(function(){let element=$(this);if(element.has("[data-leftColumn]")){let table=element.clone();table.find("thead th:not(.notHide), td").remove();table.addClass("uk-position-absolute uk-width-auto");table.css("z-index",1004);table.find("tr:first").css("border-bottom-color","#FFF");table.find("tr:first span").css({position:"relative",top:16});element.before(table);table.floatThead({floatContainerClass:"floatThead-container floatThead-alternate",top:navbar.height()})}element.floatThead({responsiveContainer:function(table){return table.parent()},top:navbar.height()})})}});$(function(){let sidebar=$("#sidebar"),body=$("body");$("a[data-sidebar]").on("click",function(e){e.preventDefault();if(sidebar.filter(":visible").length){sidebar.fadeOut(150);body.css("overflow","auto")}else{sidebar.fadeIn(150);body.css("overflow","hidden")}sidebar.find(".mdi-close, .backing").on("click",function(){sidebar.fadeOut(150);body.css("overflow","auto")})})});$(function(){let version=$("#new_version");if(version.length){UIkit.util.on(version,"hidden",function(){Cookies.set("new_version",version.data("version"),{expires:3})})}});$(function(){let body=$("body");body.on("click","[data-edit-response]",function(e){e.preventDefault();let element=$(this);$.post(element.data("link"),{action:"editResponse",responseID:element.data("edit-response"),type:element.data("type")},function(response){let responseOut=$(response),canvas=responseOut.find("canvas"),previousCanvas,context,zoom,mode="zoom",uploader=$('<div class="uploader" style="display: none;"><i class="mdi mdi-loading mdi-spin"></i><span>'+global.translations.uploaded+"</span></div>"),image=new Image,buttons=responseOut.find("button[data-button]"),actions=responseOut.find("button[data-action]"),pressed=false,strokeWeight=4,strokeButtons=responseOut.find(".strokeWeight button"),history=[],historySteps=[],lastX,lastY;uploader.appendTo("body");image.onload=function(){context=canvas[0].getContext("2d");context.drawImage(image,0,0);previousCanvas=$('<canvas width="'+canvas[0].width+'" height="'+canvas[0].height+'" style="max-width: none;"></canvas>');previousCanvas[0].getContext("2d").drawImage(canvas[0],0,0);setTimeout(function(){zoom_init()},100)};image.src=canvas.data("image");buttons.on("click",function(){let element=$(this);buttons.removeClass("uk-button-theme");buttons.addClass("uk-button-light");element.toggleClass("uk-button-theme uk-button-light");if(element.filter('[data-button="zoom"]').length){zoom.enable();mode="zoom"}else if(element.filter('[data-button="draw"]').length){zoom.disable();mode="draw"}});actions.on("click",function(){let element=$(this);switch(element.data("action")){case"rotate_left":case"rotate_right":let copyCanvas=$('<canvas width="'+canvas[0].height+'" height="'+canvas[0].width+'" style="max-width: none;"></canvas>'),copyContext=copyCanvas[0].getContext("2d"),inner=responseOut.find(".inner");if(element.data("action")=="rotate_left"){context.rotate(270*Math.PI/180);context.translate(-canvas[0].width,0)}else{context.rotate(90*Math.PI/180);context.translate(0,-canvas[0].height)}copyContext.save();if(element.data("action")=="rotate_left"){copyContext.rotate(270*Math.PI/180);copyContext.translate(-canvas[0].width,0)}else{copyContext.rotate(90*Math.PI/180);copyContext.translate(0,-canvas[0].height)}copyContext.drawImage(canvas[0],0,0);copyContext.restore();inner.html("<div></div>");inner.children().append(copyCanvas);canvas=copyCanvas;context=copyContext;previousCanvas=$('<canvas width="'+canvas[0].width+'" height="'+canvas[0].height+'" style="max-width: none;"></canvas>');previousCanvas[0].getContext("2d").drawImage(canvas[0],0,0);history=[];historySteps=[];zoom_init();draw_init();break;case"undo":if(historySteps.length){history.length=historySteps.pop();context.clearRect(0,0,canvas[0].width,canvas[0].height);context.drawImage(previousCanvas[0],0,0);for(let i=1;i<history.length;i++){let currentPoint=history[i],previousPoint=history[i-1];context.beginPath();context.strokeStyle="#FF0000";context.lineWidth=currentPoint.size;context.lineJoin="round";context.moveTo(currentPoint.x,currentPoint.y);context.lineTo(previousPoint.x,previousPoint.y);context.closePath();context.stroke()}}break}});responseOut.find('[data-action="save"]').on("click",function(){uploader.fadeIn(100);$.post(element.data("link"),{action:"editResponseSave",responseID:element.data("edit-response"),image:canvas[0].toDataURL("image/jpeg")},function(response){$('li[data-response-id="'+element.data("edit-response")+'"]').replaceWith(response);UIkit.modal(responseOut).hide();uploader.fadeOut(100)})});UIkit.modal(responseOut).show();draw_init();function draw_init(){canvas.on("mousedown touchstart",function(e){let element=$(this);if(e.touches)e=e.touches[0];pressed=true;historySteps.push(history.length);draw(e.pageX-element.offset().left,e.pageY-element.offset().top,false)});canvas.on("mousemove touchmove",function(e){let element=$(this);if(mode=="draw"){e.preventDefault();e.stopPropagation()}if(e.touches)e=e.touches[0];if(pressed)draw(e.pageX-element.offset().left,e.pageY-element.offset().top,true)});canvas.on("mouseup mouseout touchend",function(){pressed=false})}function draw(x,y,isDown){if(mode=="draw"){let tempX,tempY;if(isDown){context.beginPath();context.strokeStyle="#FF0000";context.lineWidth=strokeWeight;context.lineJoin="round";context.moveTo(lastX,lastY);context.lineTo(tempX=x/zoom.getInitialZoomFactor()/zoom.zoomFactor,tempY=y/zoom.getInitialZoomFactor()/zoom.zoomFactor);context.closePath();context.stroke()}lastX=tempX;lastY=tempY;history.push({x:tempX,y:tempY,size:strokeWeight})}}function zoom_init(){let active;zoom=new PinchZoom.default(canvas.parent()[0],{maxZoom:5,draggableUnzoomed:false,setOffsetsOnce:true});zoom.element=$(zoom.el);if(mode=="draw")zoom.disable();zoom.element.on("mousedown",function(){if(zoom.enabled){active=true;zoom.element.addClass("uk-cursor-grab")}});zoom.element.on("mousemove",function(e){if(zoom.enabled&&active){let rect=zoom.container.getBoundingClientRect(),scrollTop=document.documentElement.scrollTop||document.body.scrollTop,scrollLeft=document.documentElement.scrollLeft||document.body.scrollLeft,posTop=rect.top+scrollTop,posLeft=rect.left+scrollLeft,touch={x:e.pageX-posLeft,y:e.pageY-posTop};zoom.drag(touch,zoom.lastDragPosition);zoom.offset=zoom.sanitizeOffset(zoom.offset);zoom.lastDragPosition=touch;zoom.update()}});zoom.element.on("mouseup mouseout",function(){if(zoom.enabled){active=false;zoom.lastDragPosition=false;zoom.element.removeClass("uk-cursor-grab")}});zoom.handleZoomStart();zoom.el.addEventListener("wheel",function(e){if(zoom.enabled){let rect=zoom.container.getBoundingClientRect(),scrollTop=document.documentElement.scrollTop||document.body.scrollTop,scrollLeft=document.documentElement.scrollLeft||document.body.scrollLeft,posTop=rect.top+scrollTop,posLeft=rect.left+scrollLeft,touchCenter={x:e.pageX-posLeft,y:e.pageY-posTop},delta=e.deltaY||e.detail||e.wheelDelta,newScale=delta>0?zoom.lastScale-.5:zoom.lastScale+.5,scale;if(newScale<1.1){newScale=1;zoom.resetOffset()}if(newScale>zoom.options.maxZoom)newScale=zoom.options.maxZoom;scale=newScale/zoom.lastScale;zoom.lastScale=newScale;zoom.nthZoom+=1;zoom.scale(scale,touchCenter);zoom.drag(touchCenter);zoom.lastZoomCenter=touchCenter;zoom.update()}})}strokeButtons.on("click",function(){let element=$(this);strokeWeight=element.data("weight");strokeButtons.removeClass("active");element.addClass("active");UIkit.drop(element.closest(".strokeWeight")).hide(0)})})});body.on("click","[data-delete-edit-response]",function(e){e.preventDefault();let element=$(this);if(confirm(global.translations.delete_confirm)){$.post(element.data("link"),{action:"deleteResponse",responseID:element.data("delete-edit-response")},function(response){$('li[data-response-id="'+element.data("delete-edit-response")+'"]').replaceWith(response)})}})});function showAds(){$(function(){$("."+global.banners.more).prop("hidden",false);$('[id^="yandex_rtb"]').hide()})}$(function(){if(global.banners.full){let full=$("#"+global.banners.full);if(full.length){let fullCounter=Cookies.get("full_banner");if(!fullCounter)Cookies.set("full_banner",1);else if(fullCounter>=4)Cookies.remove("full_banner");else Cookies.set("full_banner",parseInt(fullCounter)+1);full.children("button").on("click",function(){full.fadeOut(100)})}}});$(function(){let notifications=$("[data-notification]");if(notifications.length){notifications.each(function(){let element=$(this);if(!Cookies.get(element.data("notification"))){element.prop("hidden",false);UIkit.util.on(element,"hide",function(){Cookies.set(element.data("notification"),true,{expires:element.data("days")})})}})}});$(function(){let monitoring=$("#monitoring");if(monitoring.length){let localDocument=$(document),loading=false,row;localDocument.on("click","[data-loads]",function(){let element=$(this),spinner=element.children("[data-number]");if(loading)return null;loading=true;if(!element.data("status")){spinner.html('<i class="mdi mdi-loading mdi-spin"></i>');$.get(element.data("loads"),function(response){response=$(response).filter("tr");element.data("status",response.length);spinner.text(spinner.data("number"));element.after(response);loading=false})}else{for(let i=0;i<element.data("status");i++)element.next("tr").remove();loading=false;element.data("status",0)}});localDocument.on("click","[data-view]",function(e){e.preventDefault();e.stopPropagation();let element=$(this);$.get(element.data("view"),function(response){response=$(response);response.editor=response.find("textarea[data-editor]");response.addComment=response.find("form[data-add-comment]");UIkit.modal(response).show();row=element.closest("tr[data-theme]");if(response.editor.length)response.editor=ckeditor_init(response.editor[0]);if(response.addComment.length){response.addComment.on("submit",function(e){e.preventDefault();response.button=response.addComment.find("button");response.button.hide();$.post(response.addComment.attr("action"),{comment:response.editor.getData()},function(data){response.addComment.closest("fieldset").after(data);response.editor.setData("");response.button.show()})})}})});localDocument.on("click","[data-toggle]",function(){let element=$(this),table=element.closest("table"),toggles=table.find("th[data-toggle]"),rows=table.find("tr[data-options]"),number=1;if(!element.hasClass("uk-text-danger")){toggles.removeClass("uk-text-danger");element.addClass("uk-text-danger");rows.show();rows.filter(':not([data-options~="'+element.data("toggle")+'"])').hide()}else{toggles.removeClass("uk-text-danger");rows.show()}rows.filter(":visible").children("[data-number]").each(function(){$(this).text(number++)})});localDocument.on("click","[data-approve]",function(){let element=$(this),translation=element.data("translation").split("|");$.get(element.data("approve"),function(){element.text(element.hasClass("uk-button-theme")?translation[0]:translation[1]);element.toggleClass("uk-button-theme uk-button-success");if(row.length)row.find("[data-approved]").toggleClass("mdi-checkbox-marked-circle mdi-close-circle uk-text-success uk-text-danger")})});localDocument.on("click","[data-approve-all]",function(){let element=$(this);if(element.hasClass("uk-button-theme")){if(confirm(element.data("confirm-text"))){$.get(element.data("approve-all"),function(){element.text(element.data("translation"));element.toggleClass("uk-button-theme uk-button-success");localDocument.find(".approveIcon").removeClass("mdi-close-circle uk-text-danger").addClass("mdi-checkbox-marked-circle uk-text-success")})}}});localDocument.on("click","[data-remove]",function(){let element=$(this);if(confirm(global.translations.delete_confirm)){$.get(element.data("remove"),function(){element.closest("fieldset").remove()})}})}});$(function(){$(document).on("click","[data-view-document]",function(e){e.preventDefault();let element=$(this),modal=$('<section class="uk-modal-container" data-uk-modal="stack: true;"><div class="uk-modal-dialog"><div class="uk-modal-header"><h2 class="uk-modal-title"></h2><button class="uk-modal-close-default" data-uk-close></button></div><div class="uk-modal-body" data-uk-margin="margin: uk-margin-top;"><div class="uk-flex uk-flex-between"><a href="#" class="uk-button uk-button-default" data-reload>'+global.translations.reload+'</a><a href="'+element.attr("href")+'" class="uk-button uk-button-theme" download="'+element.text()+'">'+global.translations.download+'</a></div><div><div class="uk-alert uk-alert-success">'+global.translations.view_document_warning+'</div></div><div class="iframe"></div></div></div></section>'),body=modal.find(".uk-modal-body");modal.find(".uk-modal-title").text(element.text());UIkit.modal(modal).show();UIkit.util.on(modal,"shown",function(){body.find(".iframe").html('<iframe src="https://docs.google.com/viewer?url='+element.attr("href")+'"></iframe>')});modal.find("[data-reload]").on("click",function(e){e.preventDefault();body.children(".iframe").replaceWith('<div class="iframe"><iframe src="https://docs.google.com/viewer?url='+element.attr("href")+'&embedded=true"></iframe></div>')})})});$(function(){let announcements=$("#announcements");if(announcements.length){if(announcements.filter('[data-page="edit"]').length){let addModal=$("#add_whom"),addButton=announcements.find('a[data-action="add"]'),modalTitle=addModal.find(".uk-modal-title"),modalBody=addModal.find(".uk-modal-body"),modalFooter=addModal.find(".uk-modal-footer"),modalHeading=modalTitle.children("span"),backButton=modalTitle.children("a"),actionObject,typeName,typeTranslate;modalHeading.reset=modalHeading.text();announcements.on("click","[data-action]",function(e){e.preventDefault();e.stopPropagation();let element=$(this);actionObject=element;if(element.filter('[data-action="add"], [data-action="edit"]').length){modalBody.children("[data-type]").prop("hidden",true);UIkit.modal(addModal).show()}if(element.filter('[data-action="add"], [data-action="edit"][data-type="all"]').length){modalBody.children('[data-type="types"]').prop("hidden",false);modalHeading.text(modalHeading.reset);backButton.prop("hidden",true);modalFooter.prop("hidden",true)}if(element.filter('[data-action="edit"]:not([data-type="all"])').length){let type=element.data("type"),items=element.data("items"),typeSection=modalBody.children('[data-type="'+type+'"]'),checkbox=typeSection.find("input"),currentCheckbox;typeName=type;typeTranslate=modalBody.children('[data-type="types"]').find('[data-toggle="'+type+'"]').text()+"|"+modalBody.children('[data-type="types"]').find('[data-toggle="'+type+'"]').data("translate-all");modalBody.children('[data-type="types"]').prop("hidden",true);typeSection.prop("hidden",false);modalHeading.text(modalBody.children('[data-type="types"]').find('[data-toggle="'+type+'"]').text());modalBody.find("input").prop("checked",false);modalBody.find("ul ul").prop("hidden",true);backButton.prop("hidden",false);modalFooter.prop("hidden",false);if(items.length){for(let i=0;i<items.length;i++){currentCheckbox=checkbox.filter('[value="'+items[i]+'"]');currentCheckbox.prop("checked",true);currentCheckbox.closest("ul:not([data-type])").prop("hidden",false)}checkbox.filter("[data-select-all]").each(function(){let element=$(this);element.prop("checked",!element.closest(element.data("select-all")).find("input:not([data-select-all]):not(:checked)").length)})}else{checkbox.prop("checked",true)}}if(element.filter('[data-action="delete"]').length){element.closest(".label").remove()}});addModal.find("a[data-toggle]").on("click",function(e){e.preventDefault();let element=$(this);modalBody.children('[data-type="types"]').prop("hidden",true);modalBody.children('[data-type="'+element.data("toggle")+'"]').prop("hidden",false);modalBody.find("input").prop("checked",false);modalBody.find("ul ul").prop("hidden",true);modalHeading.translate=modalHeading.text();modalHeading.text(element.text());typeName=element.data("toggle");typeTranslate=element.text()+"|"+element.data("translate-all");backButton.prop("hidden",false);modalFooter.prop("hidden",false);modalFooter.children('input[name="type"]').val(element.data("toggle"))});backButton.on("click",function(e){e.preventDefault();modalBody.children("[data-type]").prop("hidden",true);modalBody.children('[data-type="types"]').prop("hidden",false);modalHeading.text(modalHeading.translate);backButton.prop("hidden",true);modalFooter.prop("hidden",true)});modalBody.find("input[data-select-all]").on("change",function(){let element=$(this);element.closest(element.data("select-all")).find("input").prop("checked",element.prop("checked"))});modalBody.find("input").on("change",function(){let element=$(this),parent=element,checked;while(true){parent=parent.parent().closest("ul");if(!parent.length)break;if(!parent.filter("[data-type]").length){checked=true;parent.find("input").each(function(){if(!$(this).prop("checked"))checked=false});parent.parent().children("input").prop("checked",checked)}else{checked=true;parent.find("input:not([data-select-all])").each(function(){if(!$(this).prop("checked"))checked=false});parent.children(":first").find("input").prop("checked",checked)}}});addModal.find("[data-save]").on("click",function(e){e.preventDefault();let element=$(this),checkbox,IDs=[],content;if(element.data("save")=="all"){content='<span class="label uk-cursor-pointer" data-action="edit" data-type="all"><span>Все</span><i class="mdi mdi-close-circle" data-action="delete"></i><input type="hidden" name="whom[]" value="all"></span>'}else{checkbox=modalBody.children('[data-type="'+typeName+'"]').find("input:not([data-select-all])");if(checkbox.length==checkbox.filter(":checked").length){checkbox.filter(":checked").each(function(){IDs.push(parseInt($(this).val()))});content='<span class="label uk-cursor-pointer" data-action="edit" data-type="'+typeName+'" data-items="[]"><span>'+typeTranslate.split("|")[1]+'</span><i class="mdi mdi-close-circle" data-action="delete"></i><input type="hidden" name="whom[]" value="'+typeName+"|"+IDs.join(",")+'"></span>'}else{checkbox.filter(":checked").each(function(){IDs.push(parseInt($(this).val()))});content='<span class="label uk-cursor-pointer" data-action="edit" data-type="'+typeName+'" data-items="'+JSON.stringify(IDs)+'"><span>'+typeTranslate.split("|")[0]+" ("+IDs.length+"/"+checkbox.length+')</span><i class="mdi mdi-close-circle" data-action="delete"></i><input type="hidden" name="whom[]" value="'+typeName+"|"+IDs.join(",")+'"></span>'}}if(actionObject.data("action")=="add")addButton.before(content);else actionObject.replaceWith(content);UIkit.modal(addModal).hide()})}}});$(function(){let attachImages=$(".attachImages"),attachImage=$(".attachImage");if(attachImages.length){let loader=$('<div class="uploader" style="display: none;"><i class="mdi mdi-loading mdi-spin"></i><span>'+global.translations.uploaded+"</span><span data-percent></span></div>");loader.appendTo("body");attachImages.on("click",".delete",function(){$(this).closest(".parent").remove()});attachImages.find("a[data-add]").on("click",function(e){e.preventDefault();$(this).next().click()});attachImages.find('input[type="file"]').on("change",function(e){e.preventDefault();let element=$(this),name=element.closest(".attachImages").data("name");loader.show();for(let i=0;i<e.target.files.length;i++){new Compressor(e.target.files[i],{maxWidth:1920,maxHeight:1920,quality:.6,mimeType:"image/jpeg",success:function(result){let reader=new FileReader,parent=element.closest(".parent");reader.onload=function(){parent.before('<div class="parent"><div class="inner"><input type="hidden" name="'+name+'[]" value="'+reader.result+'"><a href="'+reader.result+'" class="image" style="background-image: url(\''+reader.result+'\');" data-fancybox></a><i class="delete mdi mdi-close-circle"></i></div></div>')};reader.readAsDataURL(result);if(i+1==e.target.files.length)loader.hide()}})}})}if(attachImage.length){let loader=$('<div class="uploader" style="display: none;"><i class="mdi mdi-loading mdi-spin"></i><span>'+global.translations.uploaded+"</span><span data-percent></span></div>");loader.appendTo("body");attachImage.find(".delete").on("click",function(e){e.preventDefault();e.stopPropagation();let element=$(this),inner=element.closest(".inner"),file=inner.children('input[type="file"]');if(!file.attr("name")){let image=inner.children(".image"),icon=inner.children(".icon"),input=inner.children("input[name]");input.val("-1");icon.prop("hidden",false);image.prop("hidden",true)}else{let name=inner.find("small");name.text(name.data("name"));inner.children(".delete").prop("hidden",true);file.val("-1")}});attachImage.find('input[type="file"]').on("change",function(e){e.preventDefault();let element=$(this);if(!element.attr("name")){if(e.target.files.length){loader.show();new Compressor(e.target.files[0],{maxWidth:1200,maxHeight:1200,quality:.6,mimeType:"image/jpeg",success:function(result){let reader=new FileReader,image=element.parent().children(".image"),icon=element.parent().children(".icon"),input=element.parent().children("input[name]");reader.onload=function(){image.css({"background-image":"url("+reader.result+")"});input.val(reader.result);icon.prop("hidden",true);image.prop("hidden",false)};reader.readAsDataURL(result);loader.hide()}})}}else{let parent=element.parent(),name=parent.find("small"),fileName=e.target.files.length?e.target.files[0].name:"",accept=element.attr("accept")?element.attr("accept").split(","):"",size=element.data("size")?element.data("size"):0;if(e.target.files.length&&accept&&!fileName.match(".("+accept.join("|")+")$")){UIkit.notification({message:global.translations.file_error_type,status:"warning",pos:"top-center",timeout:3e3});element.val(null)}else if(e.target.files.length&&size&&e.target.files[0].size/1024/1024>=size){UIkit.notification({message:global.translations.file_error_size.replace("NUM",size),status:"warning",pos:"top-center",timeout:3e3});element.val(null)}else{name.text(e.target.files.length?e.target.files[0].name:name.data("name"));parent.children(".delete").prop("hidden",!e.target.files.length)}}element.val("-1")})}});$(function(){let passage=$("#passage");if(passage.filter('[data-type="select"]').length){passage.find("input").on("change",function(e){$(".loader_new").show();new Compressor(e.target.files[0],{maxWidth:1200,maxHeight:1200,quality:.6,mimeType:"image/jpeg",success:function(result){let reader=new FileReader;reader.onload=function(){localStorage.setItem("passage_photo",reader.result);location.assign(passage.data("link"))};reader.readAsDataURL(result)}})})}if(passage.filter('[data-type="add"]').length){let photo=localStorage?localStorage.getItem("passage_photo"):null;if(photo){let document=passage.find('[data-document="photo"]'),image=document.find(".image");document.find(".icon").prop("hidden",true);image.prop("hidden",false);image.css({"background-image":"url("+photo+")"});document.find("input[name]").val(photo);localStorage.removeItem("passage_photo")}}});$(function(){let meals=$("#meals");if(meals.filter('[data-page="schedule"]').length){meals.on("click","[data-edit-day]",function(){let element=$(this),data=element.data("edit-day");$.post(local.url.ajax,{action:"getDay",schedule:data.schedule,week:data.week,date:data.date},function(response){response=$(response);UIkit.modal(response).show();response.find('[data-action="add"]').on("click",function(){let element=$(this),list=element.parent().prev(),listItems=list.children(),listLast=listItems.filter(":last").clone();listLast.find("option").prop("selected",false);listLast.appendTo(list)});response.on("submit",function(e){e.preventDefault();$.post(local.url.ajax,response.serialize(),function(){location.reload()})})})});meals.find("[data-add-schedule]").on("click",function(){let element=$(this);$.post(local.url.ajax,{action:"addSchedule",week:element.data("add-schedule")},function(){location.reload()})});meals.on("click","[data-description]",function(){let element=$(this);$.post(local.url.ajax,{action:"getDescription",menu:element.data("description")},function(response){response=$(response);UIkit.modal(response).show();UIkit.util.on(response,"hidden",function(){response.remove()})})});meals.on("click","[data-edit-classes]",function(){let element=$(this),data=element.data("edit-classes");$.post(local.url.ajax,{action:"getClasses",schedule:data.schedule,week:data.week},function(response){response=$(response);response.find("select").select2({width:"100%",tags:true});UIkit.modal(response).show();response.on("submit",function(e){e.preventDefault();$.post(local.url.ajax,response.serialize(),function(){location.reload()})})})})}});$(function(){let books=$("#books");if(books.filter('[data-page="view"]').length){books.find("button[data-view-book]").on("click",function(){let element=$(this),type=element.data("view-book"),bookContainer=element.parent().next(),bookURL=element.data("url");if(bookURL){switch(type){case"pdf":bookContainer.append('<div class="common_embed common_embed_book"><iframe src="'+bookURL+'"></iframe></div>');break;case"mp3":bookContainer.append('<audio src="'+bookURL+'" controls>');break}element.data("url","")}bookContainer.fadeToggle(100)})}if(books.filter('[data-page="edit"]').length){books.find('input[name="shared"]').on("click",function(){let element=$(this);if(element.filter(":checked").length)books.find('input[name="forAll"]').prop("checked",true)})}});$(function(){let clipboard=$("[data-clipboard-text]");if(clipboard.length){clipboard=new ClipboardJS("[data-clipboard-text]");clipboard.on("success",function(){UIkit.notification({message:global.translations.link_copied,status:"success",pos:"top-center",timeout:3e3})})}});$(function(){let banners=$("[data-banner]");if(banners.length){banners.each(function(){let element=$(this),name=element.data("banner"),period=element.data("period")?parseInt(element.data("period")):2;banners.children(".close").on("click",function(){Cookies.set(name,true,{expires:period});element.fadeOut(ANIMATION_SPEED)})})}});$(function(){let themes=$("[data-select-theme]");if(themes.length){themes.on("click",function(e){e.preventDefault();let element=$(this),loader=element.data("loader");if(element.data("is-selected"))return null;let data=element.data("select-theme"),loading=$('<i class="mdi mdi-loading mdi-spin"></i>');element.data("is-selected",true);if(loader=="inner")element.prepend(loading);else element.before(loading);data.action="selectThemeModal";$.post(local.links.themes,data,function(response){response=$(response);let yearThemes=response.find("[data-year]");loading.remove();element.data("is-selected",false);response.on("click",'[data-action="delete"]',function(e){e.preventDefault();let element=$(this);$.post(element.attr("href"),function(){location.reload()})});response.find("select[data-select-year]").on("change",function(){let element=$(this);yearThemes.prop("hidden",true);yearThemes.filter('[data-year="'+element.val()+'"]').prop("hidden",false)});response.sectionPlans=response.find('[data-section="plans"]');response.sectionThemes=response.find('[data-section="themes"]');response.find("[data-plan]").on("click",function(){let element=$(this);$.post(response.data("themes"),{action:"getThemes",withoutCheckbox:true,dataAttribute:"theme",plan:element.data("plan")},function(responseInner){response.sectionThemes.children("ul").html(responseInner);response.sectionPlans.prop("hidden",true);response.sectionThemes.prop("hidden",false)})});response.find('[data-action="return"]').on("click",function(e){e.preventDefault();response.sectionPlans.prop("hidden",false);response.sectionThemes.prop("hidden",true)});response.on("click","[data-theme]",function(e){e.preventDefault();let element=$(this);if(confirm(local.translations.confirm_import)){$.post(response.data("themes"),{action:element.data("attach")?"attachTheme":"importAttach",lesson:response.data("lesson"),theme:element.data("theme")},function(){location.reload()})}});response.on("click","[data-view]",function(e){e.preventDefault();let element=$(this);$.post(response.data("themes"),{action:"get",theme:element.data("view"),withoutButtons:true},function(response){UIkit.modal(response).show()})});UIkit.modal(response).show()})})}});$(function(){let edits=$("[data-quick-edit]");if(edits.length){edits.on("click",function(e){e.preventDefault();let element=$(this),data=element.data("quick-edit"),replace=data.replace?$(data.replace):element.find(".elementFixed-content").length?element.find(".elementFixed-content"):element,warning=data.warning?data.warning=="self"?element:data.warning=="replace"?replace:element.closest(data.warning):null;$.get(data.url,function(response_out){let tags;response_out=$(response_out);tags=response_out.find("select[data-select-tags]");if(!data.multiple){response_out.field=response_out.find('[name="field"]');switch(data.type){case"date":new Cleave(response_out.field[0],{date:true,delimiter:"."});break}UIkit.modal(response_out).show();response_out.on("submit",function(e){e.preventDefault();$.post(data.url,response_out.serialize(),function(response_in){replace.html(response_in.value);if(warning){if(response_in.warning)warning.addClass("uk-text-warning");else warning.removeClass("uk-text-warning")}if(data.reload)location.reload()});UIkit.modal(response_out).hide()})}else{let dates=response_out.find("[data-date]");if(dates.length){dates.flatpickr({disableMobile:true,locale:"ru"})}UIkit.modal(response_out).show();response_out.on("submit",function(e){e.preventDefault();$.post(data.url,response_out.serialize(),function(response_in){replace.html(response_in.value);if(warning){if(response_in.warning)warning.addClass("uk-text-warning");else warning.removeClass("uk-text-warning")}});UIkit.modal(response_out).hide()})}if(tags.length){tags.select2({tags:true})}})})}});$(function(){let filters=$("[data-cookie-toggle]");if(filters.length){filters.on("click",function(){let element=$(this),data=element.data("cookie-toggle"),target=$(data.target);if(Cookies.get(data.name)){Cookies.remove(data.name);target.prop("hidden",false)}else{Cookies.set(data.name,"hidden",{expires:365});target.prop("hidden",true)}window.scrollTo(window.pageXOffset,window.pageYOffset-1);window.scrollTo(window.pageXOffset,window.pageYOffset+1)})}});$(function(){let menu=$("ul[data-flex-menu]");if(menu.length){menu.flexMenu({cutoff:0,linkText:'Еще <i class="mdi mdi-menu-down"></i>',linkTitle:"",showOnHover:true})}});$(function(){let elements=$("[data-download-ajax]");if(elements.length){elements.each(function(){let element=$(this);if(element.filter("form").length){element.on("submit",function(e){let element=$(this);if(element.data("download-ajax-confirm")&&!confirm(element.data("download-ajax-confirm")))return false;else e.preventDefault();let uploader=$('<div class="uploader" style="display: none;"><i class="mdi mdi-loading mdi-spin"></i><span>'+global.translations.reportFormed+"</span></div>");uploader.appendTo("body");uploader.show();$.ajax({method:element.data("method")?element.data("method"):"POST",url:element.attr("action"),dataType:"binary",data:element.serialize(),xhrFields:{responseType:"blob"},success:function(response){let link=document.createElement("a");link.href=URL.createObjectURL(response);link.download=element.data("download-ajax");link.click();uploader.hide()}})})}else{element.on("click",function(e){e.preventDefault();let element=$(this),uploader=$('<div class="uploader" style="display: none;"><i class="mdi mdi-loading mdi-spin"></i><span>'+global.translations.reportFormed+"</span></div>");uploader.appendTo("body");uploader.show();$.ajax({url:element.attr("href"),dataType:"binary",xhrFields:{responseType:"blob"},success:function(response){let link=document.createElement("a");link.href=URL.createObjectURL(response);link.download=element.data("download-ajax");link.click();uploader.hide()}})})}})}});$(function(){let program=$("#program");if(program.length){let sections=program.find("[data-section]"),templates=program.find("[data-template]");sections.subjects=sections.filter('[data-section="subjects"]');templates.subject=templates.filter('[data-template="subject"]');templates.withGroups=templates.filter('[data-template="withGroups"]');templates.withoutGroups=templates.filter('[data-template="withoutGroups"]');templates.student=templates.filter('[data-template="student"]');program.find('select[name="program"]').on("change",function(){let element=$(this);sections.subjects.empty();if(element.val()){globalPrograms[element.val()].forEach(function(current,index){let subject=templates.subject.clone(),type=subject.find("[data-select-type]");subject.find("[data-subject]").text(current.subject.title);subject.find("[data-subject]").prev().attr("name","inner["+current.id+"]");type.attr("name","type["+current.id+"]");selectType(type,templates,current);type.on("change",function(){selectType(type,templates,current)});sections.subjects.append(subject)});program.find("[data-toggle-subject]").on("change",function(){let element=$(this);if(element.prop("checked")){element.parent().next().prop("hidden",false);element.closest("[data-template]").find("[data-content]").prop("hidden",false)}else{element.parent().next().prop("hidden",true);element.closest("[data-template]").find("[data-content]").prop("hidden",true)}});sections.prop("hidden",false)}else{sections.prop("hidden",true)}});function selectType(element,templates,current){let parent=element.parent(),data=element.val()==1?templates.withoutGroups.clone():templates.withGroups.clone();if(parent.next())parent.next().remove();parent.after(data);if(element.val()==1){data.find("[data-teacher]").attr("name","teacher["+current.id+"]");data.find("[data-room]").attr("name","room["+current.id+"]");data.find("[data-loads]").attr("name","loads["+current.id+"]").val(current.load);data.find("[data-in-day]").attr("name","inDay["+current.id+"]").val(current.inDay)}else{data.find("[data-toggle-group]").each(function(index){let element=$(this),parent=element.closest("[data-closest]"),students=parent.find("[data-students]"),number=index+1;parent.find("[data-toggle-group]").attr("name","group["+current.id+"]["+number+"]");parent.find("[data-teacher]").attr("name","teacher["+current.id+"]["+number+"]");parent.find("[data-room]").attr("name","room["+current.id+"]["+number+"]");parent.find("[data-loads]").attr("name","loads["+current.id+"]["+number+"]").val(current.load);parent.find("[data-in-day]").attr("name","inDay["+current.id+"]["+number+"]").val(current.inDay);if(current.groups&&(current.groups[1]||current.groups[2])){if(current.groups[number]){current.groups[number].forEach(function(studentID){let student=templates.student.clone();student.children("span").text(globalStudents[studentID].name);student.children("input").attr("name","student["+current.id+"]["+number+"][]").val(studentID);students.append(student);Sortable.create(students[0],{group:"students_"+current.id,onEnd:function(e){e.item}})})}}else{if(globalGroups[number]){globalGroups[number].forEach(function(studentID){let student=templates.student.clone();student.children("span").text(globalStudents[studentID].name);student.children("input").attr("name","student["+current.id+"]["+number+"][]").val(studentID);students.append(student);Sortable.create(students[0],{group:"students_"+current.id,onEnd:function(e){}})})}}})}data.find("[data-toggle-group]").on("change",function(){let element=$(this);if(element.prop("checked")){element.closest("div").next().find("input, select").prop("disabled",false)}else{element.closest("div").next().find("input, select").prop("disabled",true)}})}}});$(function(){let modal=$("[data-get-modal]");if(modal.length){$("body").on("click","[data-get-modal]",function(e){e.preventDefault();e.stopPropagation();let element=$(this);$.get(element.data("get-modal"),function(response){let data={};response=$(response);if((data.selectAll=response.find("input[data-select-all]")).length){data.selectAll.on("click",function(){let element=$(this);element.closest("[data-select-parent]").find("input[data-checked-element]").prop("checked",element.prop("checked"))})}UIkit.modal(response).show()})})}});$(function(){let element=$("#fromClass");if(element.length){element.on("submit",function(e){e.preventDefault();$.post(element.attr("action"),{fromID:element.find("input:checked").val(),toID:element.data("to-class")},function(){location.reload()})})}});$(function(){let modals=$("[data-open-modal]");if(modals.length)openModalInit(modals)});function openModalInit(modals){modals.on("click",function(e){e.preventDefault();let element=$(this);$.get(element.data("open-modal"),function(response){response=$(response);let form=response.find("[data-send-reload]"),date=response.find("[data-date]"),openModal=response.find("[data-open-modal]");form.on("submit",function(e){e.preventDefault();let formData=new FormData(form.get(0));$.ajax({url:form.attr("action"),type:"POST",cache:false,contentType:false,processData:false,data:formData,success:function(){location.reload()}})});UIkit.modal(response).show();if(openModal.length)openModalInit(openModal);if(date.length){date.each(function(){let element=$(this);element.flatpickr({disableMobile:true,locale:"ru"})})}})})}$(function(){let transfers=$("#transfers");if(transfers.length){window.isTransferEdit=false;window.transferLine=null;window.studentData=null;window.studentModal=null;transfers.find(".search").on("submit",function(e){e.preventDefault();let element=$(this);if($.trim(element.find("input").val()).length>=2){$.post(element.attr("action"),element.serialize(),function(response){response=$(response);initOpenModal(response.find("[data-open]"),false);UIkit.modal(response).show()})}else{UIkit.notification({message:element.data("min-length"),status:"warning",pos:"top-center"})}});initOpenModal(transfers.find("[data-open]"),true);function initOpenModal(modals,first){modals.on("click",function(e){e.preventDefault();let element=$(this),linkInit;if(!first)window.transferLine=element;linkInit=element;$.get(element.data("open"),function(response){response=$(response);let openModals=response.find("[data-open]"),studentData=response.find("#studentData"),payments=response.find("#payments"),next=response.find("#next"),cancelSecond=response.find("[data-cancel-second]"),deleteAccount=response.find("[data-delete-account]"),exceptionAccount=response.find("[data-student-exception]"),toClass=response.find("[data-transfer-to-class]");if(!first)window.studentModal=response;UIkit.modal(response).show();if(openModals.length)initOpenModal(openModals,false);UIkit.util.on(response,"hide",function(){if(first&&window.isTransferEdit){$("body").append('<div class="uploader"><i class="mdi mdi-loading mdi-spin"></i></div>');location.reload()}});if(payments.length){payments.find("form").on("submit",function(e){e.preventDefault();let element=$(this);$.post(element.attr("action"),element.serialize(),function(){UIkit.modal(response).hide()})})}if(next.length){next.on("submit",function(e){e.preventDefault();$.post(next.attr("action"),next.serialize(),function(){window.isTransferEdit=true;window.transferLine.remove();UIkit.modal(response).hide()})})}if(cancelSecond.length){cancelSecond.on("click",function(e){e.preventDefault();if(confirm(cancelSecond.data("confirm-action"))){$.post(cancelSecond.data("cancel-second"),function(){window.isTransferEdit=true;UIkit.modal(response).hide()})}})}if(deleteAccount.length){deleteAccount.on("click",function(){if(confirm(deleteAccount.data("confirm-action"))){$.post(deleteAccount.data("delete-account"),function(){UIkit.modal(response).hide();window.isTransferEdit=true;window.transferLine.remove()})}})}if(toClass.length){toClass.on("click",function(){$.post(toClass.data("transfer-to-class"),function(response){response=$(response);let date=response.find('input[name="date"]');date.params=date.data("params");flatpickr(date[0],{dateFormat:"d.m.Y",minDate:date.params.after,maxDate:date.params.before,locale:"ru"});UIkit.modal(response).show();response.on("submit",function(e){e.preventDefault();if(confirm(response.data("confirm-action"))){$.post(response.attr("action"),response.serialize(),function(inner){inner=$.parseJSON(inner);window.studentData.html(inner.profile);window.studentModal.find("[data-transfers-list]").append(inner.line);UIkit.modal(response).hide();window.isTransferEdit=true})}})})})}if(exceptionAccount.length){exceptionAccount.on("click",function(){$.post(exceptionAccount.data("student-exception"),function(response){response=$(response);let date=response.find('input[name="date"]');date.params=date.data("params");flatpickr(date[0],{dateFormat:"d.m.Y",minDate:date.params.after,maxDate:date.params.before,locale:"ru"});UIkit.modal(response).show();response.on("submit",function(e){e.preventDefault();if(confirm(response.data("confirm-action"))){$.post(response.attr("action"),response.serialize(),function(inner){inner=$.parseJSON(inner);window.studentData.html(inner.profile);window.studentModal.find("[data-transfers-list]").append(inner.line);window.studentModal.find("[data-action-buttons").remove();UIkit.modal(response).hide();window.isTransferEdit=true})}})})})}if(studentData.length)window.studentData=studentData})})}initOpenTransfer()}function initOpenTransfer(){$("body").on("click","[data-open-transfer]",function(e){e.preventDefault();let element=$(this);$.get(element.data("open-transfer"),function(response){response=$(response);let edit=response.find("#editTransfer"),date=edit.find('input[name="date"]'),deleteTransfer=response.find("[data-delete-transfer]"),toClass=response.find('select[name="class"]'),reason=response.find('select[name="reason"]'),transfer=response;if(edit.length){date.params=date.data("params");flatpickr(date[0],{dateFormat:"d.m.Y",minDate:date.params.after,maxDate:date.params.before,locale:"ru"});if(reason.length){if(reason.val()==88)date.prop("disabled",true);reason.on("change",function(){if(reason.val()==88)date.val(date.data("start-year")).prop("disabled",true);else date.prop("disabled",false)})}edit.on("submit",function(e){e.preventDefault();if(!toClass.length||toClass.val()==toClass.data("current")||confirm(toClass.data("confirm-action").replace("{class}",toClass.children(":selected").text()))){if(!reason.length||reason.val()!=90||confirm(reason.data("confirm"))){if(confirm(edit.data("action-confirm"))){$.post(edit.attr("action"),edit.serialize(),function(response){if(element.data("simple")){location.reload()}else{if(reason.length&&reason.val()==90){UIkit.modal(transfer).hide();UIkit.modal(window.studentModal).hide();window.isTransferEdit=true;window.transferLine.remove()}else{response=$.parseJSON(response);element.replaceWith(response.line);window.studentData.html(response.profile);UIkit.modal(transfer).hide();window.isTransferEdit=true;if(toClass.length&&toClass.val()!=toClass.data("current"))window.transferLine.remove()}}})}}}})}if(deleteTransfer.length){deleteTransfer.on("click",function(){if(confirm(deleteTransfer.data("confirm-action"))){$.post(deleteTransfer.data("delete-transfer"),deleteTransfer.data("params"),function(response){if(element.data("simple")){location.reload()}else{window.studentData.html(response);UIkit.modal(transfer).hide();window.isTransferEdit=true;window.transferLine.remove();element.remove()}})}})}UIkit.modal(response).show()})})}});$(function(){let selects=$("[data-ajax-selects]");selects.on("change",function(){let element=$(this);$.post(window.ajaxSelectURL?window.ajaxSelectURL:location.href,{itemID:element.data("ajax-selects"),field:element.attr("name"),value:element.val()},function(){location.reload()})})});$(function(){let birth=$("#birth");if(birth.length){let balloon=birth.children(".balloon"),window_=$(window);balloon.on("click",function(){let random=Math.random(),firework=$('<canvas id="firework'+random+'" class="uk-position-top-left" width="'+window_.width()+'" height="'+window_.height()+'"></canvas>');birth.append(firework);firework.init=JS_FIREWORKS.Fireworks({id:"firework"+random,hue:250,particleCount:50,delay:0,minDelay:20,maxDelay:40,boundaries:{top:50,bottom:240,left:50,right:window_.width()-50},fireworkSpeed:1.5,fireworkAcceleration:1.05,particleFriction:.95,particleGravity:1.5});firework.init.start();setTimeout(function(){firework.fadeOut(ANIMATION_SPEED*10,function(){firework.remove()})},7500)})}});$(function(){let selects=$("[data-select-buttons]");if(selects.length){selects.each(function(){let element=$(this),select=element.find("select"),name=select.attr("name");element.find("[data-select-items]").on("click",function(e){e.preventDefault();let element=$(this),items=element.data("select-items").toString().split("|");if(items.length){let current=window.selects[name].val();if(select.prop("multiple")){if(!current)current=[];items.forEach(function(value){current.push(value)})}else{current=items[0]}select.val(current);select.trigger("change")}})})}});$(function(){let elements=$("select[data-quick-select]");if(elements.length){elements.on("change",function(){let element=$(this);$.post(element.children("option:selected").data("url"),function(){location.reload()})})}});$(function(){let tags=$("[data-select-tags]");if(tags.length){if(!window.selects)window.selects={};tags.each(function(){let element=$(this);window.selects[element.attr("name")]=element.select2({tags:true})})}});$(function(){let elements=$("[data-show-rows]");if(elements.length){let rows=elements.find("tr");elements.find("[data-show]").on("click",function(e){e.preventDefault();let element=$(this);if(!element.hasClass("shown")){rows.filter("."+element.data("show")).prop("hidden",false);element.addClass("shown")}else{rows.filter("."+element.data("hide")).prop("hidden",true).removeClass("shown");element.removeClass("shown")}})}});$(function(){let themes=$("[data-view-theme-ajax]");if(themes.length){themes.on("click",function(e){e.preventDefault();let element=$(this);$.post(local.links.themes,{action:"getJournalTheme",theme:element.data("view-theme-ajax")},function(response){UIkit.modal(response).show()})})}});$(function(){let selects=$("select[data-view-on-select]");if(selects.length){selects.on("change",function(){let element=$(this),values=element.parent().children("[data-value]");values.prop("hidden",true);values.filter('[data-value="'+element.val()+'"]').prop("hidden",false)})}});$(function(){if($("[data-get-archives]").length)getArchivesInit()});function getArchivesInit(){$("body").on("click","[data-get-archives]",function(e){e.preventDefault();let element=$(this),data=element.data("get-archives");$.post(global.links.getArchives,{action:"get",type:data.type,itemID:data.itemID,year:data.year},function(response){response=$(response);response.find("[data-recovery]").on("click",function(){let element=$(this);if(confirm(global.translations.recoveryConfirm)){$.post(global.links.getArchives,{action:"recovery",loadID:element.data("recovery")},function(){location.reload()})}});response.find("[data-merge]").on("click",function(e){e.preventDefault();let element=$(this);$.post(global.links.getArchives,{action:"getMerge",loadID:element.data("merge")},function(response){response=$(response);response.on("submit",function(e){e.preventDefault();$.post(global.links.getArchives,{action:"mergeLoads",loadID:element.data("merge"),withLoadID:response.find('[name="load"]').val()},function(){location.reload()})});UIkit.modal(response).show()})});UIkit.modal(response).show()})})}$(function(){let archive=$("#archive");if(archive.filter('[data-page="students"]').length){archive.find("[data-view-archive]").on("click",function(e){e.preventDefault();let element=$(this);$.post(element.data("view-archive"),function(response){response=$(response);let restoreStudent=response.find("#restoreStudent");restoreStudent.on("submit",function(e){e.preventDefault();if(confirm(restoreStudent.data("action-confirm"))){$.post(restoreStudent.attr("action"),restoreStudent.serialize(),function(){location.reload()})}});UIkit.modal(response).show()})})}});$(function(){let thead=$("#leftFixed");if(thead.length){let theadClone;setTimeout(function(){theadClone=thead.parent().clone();theadClone.find("td, th:not(.notHide)").remove();theadClone.addClass("uk-position-left");theadClone.children().css("width","auto");theadClone.find(".notHide:first").height(thead.find(".notHide:first").height());theadClone.find("th:first").width(thead.find("th:first").width());thead.parent().after(theadClone);$(window).on("resize",alignTable);function alignTable(){if(!thead.notHide)thead.notHide=$(".floatThead-table .notHide:first");setTimeout(function(){theadClone.find(".notHide:first").height(thead.notHide.height());theadClone.find("th:first").width(thead.notHide.width())},250)}thead.closest(".uk-overflow-auto").on("scroll",function(){let element=$(this);theadClone.css("left",element.scrollLeft())})},250);setTimeout(function(){thead.floatThead({scrollContainer:function(table){return table.closest(".uk-overflow-auto")}})},250)}});function isJSON(value){try{JSON.parse(value)}catch(e){return false}return true}$(function(){let accordion=$("[data-accordion-module]");if(accordion.length){let inner=accordion.children(),current=inner.filter(".accordion-current");accordion.addClass("accordion");inner.addClass("accordion-inner");if(current.length)current.addClass("accordion-current");else inner.filter(":first").addClass("accordion-current");accordion.on("click",".accordion-inner:not(.accordion-current)",function(e){e.preventDefault();let element=$(this);inner.removeClass("accordion-current");element.addClass("accordion-current")})}});$(function(){let elements=$("table[data-table-fixer]");if(elements.length){elements.each(function(){let element=$(this),fixed=$([]),fixedColumns=$([]),cells=element.find("th, td"),data=element.data("table-fixer"),position=0,width,right={element:null,offset:0};element.wrap('<div class="elementFixed-wrapper '+(data.class?data.class:"")+'"></div>');cells.each(function(){$(this).children(":not(.elementFixed-exclude)").wrapAll('<div class="elementFixed-content"></div>')});cells.prepend('<div class="elementFixed-design"></div>');if(data.left){element.find("tr").each(function(){$(this).children(":lt("+data.left+")").each(function(){let element=$(this);if(element.cellPos().left<data.left){if(element.cellPos().left<data.left)element.css("z-index",25);fixedColumns=fixedColumns.add(element);if(element.offset().left>right.offset){right.element=element;right.offset=element.offset().left}}});$(this).children(":eq("+(data.left-1)+")").each(function(){let element=$(this);if(element.cellPos().left<data.left){element.css("z-index",25);fixed=fixed.add(element.children(".elementFixed-design"))}})})}element.tableHeadFixer({head:data.head,left:data.left});element.wrapper=element.parent();element.classAdded=false;element.wrapper.on("scroll",function(){if(!element.classAdded&&element.wrapper.scrollLeft()>0)fixed.addClass("elementFixed-shadow");else fixed.removeClass("elementFixed-shadow")});if(data.leftFixed){element.wrapper.on("scroll",function(){if(window.matchMedia("(max-width: 639px)").matches){width=right.element.offset().left+right.element.width();width-=width-element.wrapper.scrollLeft();if(element.wrapper.scrollLeft()>position){fixedColumns.css("transform","translateX(-"+width+"px)")}else if(element.wrapper.scrollLeft()<position){fixedColumns.css("transform","none")}position=element.wrapper.scrollLeft()}})}})}});$(function(){let payments=$("#payments");if(payments.filter('[data-page="classes"]').length){$("body").on("change","[data-student-status]",function(){let element=$(this),row=element.closest("tr");$.post(local.links.toggleStatus,{student:element.data("student-status")},function(response){response=$(response);response.find("[data-number-student]").text(row.find("[data-number-student]").text());row.replaceWith(response)})})}});function initAjaxTooltip(){$("body").on("click","[data-ajax-tooltip]",function(){let element=$(this);if(!element.data("opened")){$.post(element.data("ajax-tooltip"),function(response){element.tooltipster({content:response,contentAsHTML:true,interactive:true,theme:"tooltipster-shadow",trigger:"click"}).tooltipster("open")});element.data("opened",true)}})}$(function(){let scrollEnd=$(".scrollEnd");if(scrollEnd.length){scrollEnd.each(function(){let element=$(this);element.scrollTop(element.prop("scrollHeight"));element.scrollLeft(element.prop("scrollWidth"))})}});$(function(){$("body").on("click","[data-click-loader]",function(){$("body").append('<div class="uploader"><i class="mdi mdi-loading mdi-spin"></i><span>'+global.translations.pleaseWait+"</span></div>")})});$(function(){let alphabet=$("#alphabet");if(alphabet.filter('[data-page="letters"]').length){alphabet.find("[data-edit-access]").on("click",function(e){e.preventDefault();e.stopPropagation();let element=$(this);$.post(element.data("edit-access"),function(response){response=$(response);response.find("select").select2({width:"100%"});response.on("submit",function(e){e.preventDefault();$.post(response.attr("action"),response.serialize(),function(){location.reload()})});UIkit.modal(response).show()})})}});$(function(){let pagination=$("[data-pagination]");if(pagination.length){pagination.each(function(){let element=$(this),pages=element.find("[data-pagination-page]"),buttons=element.find("[data-pagination-button]"),current=1;buttons.filter('[data-pagination-button="next"]').on("click",function(){current++;pages.prop("hidden",true);pages.filter('[data-pagination-page="'+current+'"]').prop("hidden",false);if(current==pages.length){buttons.prop("hidden",true);buttons.filter('[data-pagination-button="last"]').prop("hidden",false)}})})}});